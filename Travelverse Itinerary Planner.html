
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travelverse Itinerary Planner</title>

    <!-- External libraries for PDF generation - Internet Connection Required -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- External library for Drag-and-Drop - Internet Connection Required -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- Google Sign-In API -->
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <meta name="google-signin-client_id" content="359915756783-i8ccoerqfh4ht7nfkva3qm5bi6kkjf2j.apps.googleusercontent.com">
    
    <!-- Google OAuth 2.0 -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- 
    🔧 GOOGLE AUTHENTICATION SETUP GUIDE:
    
    1. Go to Google Cloud Console: https://console.cloud.google.com/
    2. Create a new project or select existing one
    3. Enable Google+ API: APIs & Services → Library → Search "Google+ API"
    4. Create OAuth 2.0 Credentials: APIs & Services → Credentials → Create Credentials → OAuth 2.0 Client IDs
    5. Choose "Web application"
    6. Add Authorized JavaScript origins: http://localhost:3000 (for development)
    7. Add Authorized redirect URIs: http://localhost:3000
    8. Copy the generated Client ID
    9. Replace "YOUR_GOOGLE_CLIENT_ID" in this file with your actual Client ID
    10. Test the authentication!
    -->


    <style>
        /* --- Google Font --- */
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

        /* --- MODERN UI - APPLE INSPIRED --- */
        :root {
            --brand-blue: #05C3DE; /* Updated Brand Color */
            --brand-blue-light: #4ee0f0; /* Lighter version of new brand color */
            --bg-color: #f5f5f7;
            --card-bg-color: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #515154;
            --border-color: #d2d2d7;
            --error-color: #bf0a28;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --radius-l: 18px;
            --radius-m: 12px;
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --card-bg-color: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Theme Transition */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container { max-width: 960px; margin: 40px auto; padding: 20px; }

        /* Authentication Styles */
        .auth-section {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--brand-blue), var(--brand-blue-light));
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-overlay {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-l);
            padding: 40px;
            box-shadow: var(--shadow);
        }

        .auth-card {
            background: var(--card-bg-color);
            border-radius: var(--radius-l);
            padding: 40px;
            text-align: center;
            max-width: 400px;
            box-shadow: var(--shadow);
        }

        .auth-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--brand-blue), var(--brand-blue-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auth-header p {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .auth-content h2 {
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .auth-content p {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .google-signin-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: white;
            color: #333;
            border: 1px solid #ddd;
            border-radius: var(--radius-m);
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .google-signin-btn:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }

        .google-icon {
            width: 18px;
            height: 18px;
        }

        .guest-btn {
            background: var(--bg-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-m);
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .guest-btn:hover {
            background: var(--border-color);
        }

        .auth-note {
            margin-top: 15px;
            text-align: center;
        }

        .auth-note small {
            color: var(--text-secondary);
            font-style: italic;
        }

        /* User Profile Styles */
        .user-profile {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-m);
            padding: 15px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--brand-blue);
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .user-email {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .profile-btn, .logout-btn {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-m);
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .profile-btn:hover, .logout-btn:hover {
            background: var(--border-color);
        }

        /* Dashboard Modal Styles */
        .dashboard-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dashboard-modal {
            background: var(--card-bg-color);
            border-radius: var(--radius-l);
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .dashboard-header h2 {
            color: var(--text-primary);
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 5px;
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-m);
            padding: 20px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2rem;
            color: var(--brand-blue);
            margin: 0 0 5px 0;
        }

        .stat-card p {
            color: var(--text-secondary);
            margin: 0;
        }

        .dashboard-recent h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .itinerary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-m);
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .itinerary-item:hover {
            background: var(--bg-color);
            border-color: var(--brand-blue);
        }

        .itinerary-info h4 {
            color: var(--text-primary);
            margin: 0 0 5px 0;
        }

        .itinerary-info p {
            color: var(--text-secondary);
            margin: 0;
            font-size: 0.9rem;
        }

        .load-btn {
            background: var(--brand-blue);
            color: white;
            border: none;
            border-radius: var(--radius-m);
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .load-btn:hover {
            background: var(--brand-blue-dark);
        }

        /* Enhanced Collapsible Sections */
        .collapsible .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 18px 20px;
            background: var(--card-bg-color);
            border-bottom: 1px solid var(--border-color);
            border-radius: var(--radius-m) var(--radius-m) 0 0;
            transition: all 0.3s ease;
            user-select: none;
        }

        .collapsible .card-header:hover {
            background: var(--bg-color);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .collapsible .card-header h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .toggle-icon {
            font-size: 1.1rem;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            font-weight: bold;
        }

        .collapsible.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .collapsible .card-content {
            padding: 20px;
            transition: all 0.3s ease;
            overflow: hidden;
            max-height: none;
        }

        .collapsible.collapsed .card-content {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
        }

        .collapsible.collapsed {
            margin-bottom: 10px;
        }

        /* Collapse/Expand All Buttons */
        .section-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .section-control-btn {
            background: var(--brand-blue);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-m);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .section-control-btn:hover {
            background: var(--brand-blue-light);
            transform: translateY(-1px);
        }
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--card-bg-color);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 12px;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .theme-toggle .icon {
            font-size: 1.2rem;
            color: var(--text-primary);
        }
        


        header { text-align: center; margin-bottom: 40px; }
        
        /* Progress Bar */
        .progress-container {
            margin-top: 20px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--brand-blue), var(--brand-blue-light));
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 0%;
        }
        
        .progress-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Weather and Insurance Containers */
        .weather-container, .insurance-container {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-color);
            border-radius: var(--radius-m);
            border: 1px solid var(--border-color);
        }
        
        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .weather-day {
            background: var(--card-bg-color);
            padding: 15px;
            border-radius: var(--radius-m);
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .weather-day .date {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .weather-day .temp {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--brand-blue);
            margin-bottom: 5px;
        }
        
        .weather-day .condition {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .insurance-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--card-bg-color);
            border-radius: var(--radius-m);
            margin-top: 15px;
        }
        
        .insurance-details {
            flex: 1;
        }
        
        .insurance-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--brand-blue);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }
        
        .error-message {
            color: var(--error-color);
            text-align: center;
            padding: 10px;
            background: #fff0f2;
            border-radius: var(--radius-m);
            margin-top: 10px;
        }
        
        .visa-container {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-color);
            border-radius: var(--radius-m);
            border: 1px solid var(--border-color);
        }
        
        .visa-info {
            background: var(--card-bg-color);
            padding: 20px;
            border-radius: var(--radius-m);
            margin-bottom: 15px;
            border-left: 4px solid var(--brand-blue);
        }
        
        .visa-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .visa-required {
            background: #fff3cd;
            color: #856404;
        }
        
        .visa-not-required {
            background: #d4edda;
            color: #155724;
        }
        
        .visa-on-arrival {
            background: #cce5ff;
            color: #004085;
        }
        
        .visa-details {
            margin-top: 15px;
        }
        
        .visa-details h5 {
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .visa-details ul {
            margin: 0;
            padding-left: 20px;
            color: var(--text-secondary);
        }
        
        .visa-details li {
            margin-bottom: 5px;
        }
        

        

        
        .timezone-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .timezone-card {
            background: var(--card-bg-color);
            padding: 15px;
            border-radius: var(--radius-m);
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .timezone-card .city {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .timezone-card .time {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--brand-blue);
            margin-bottom: 5px;
        }
        
        .timezone-card .date {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        

        h1 {
            font-size: 3.5rem;
            font-weight: 800;
            letter-spacing: -1.5px;
            background: linear-gradient(45deg, #333, var(--brand-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .card {
            background-color: var(--card-bg-color);
            border-radius: var(--radius-l);
            box-shadow: var(--shadow);
            padding: 35px 40px;
            margin-bottom: 30px;
            border: 1px solid rgba(0,0,0,0.05);
            animation: fadeIn 0.5s ease-out;
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row .full-width {
            grid-column: 1 / -1;
        }

        .form-group { display: flex; flex-direction: column; }
        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        input, select {
            width: 100%;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-m);
            font-size: 1rem;
            transition: all 0.2s ease;
            background-color: #fafafa;
        }

        input:disabled {
            background-color: #f0f0f2;
            cursor: not-allowed;
            color: #999;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--brand-blue);
            box-shadow: 0 0 0 4px rgba(5, 195, 222, 0.15); /* Updated focus color */
            background-color: #fff;
        }

        button {
            border: none;
            border-radius: var(--radius-m);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--brand-blue);
            color: white;
            padding: 18px 28px;
            width: 100%;
            font-size: 1.2rem;
            box-shadow: 0 4px 10px rgba(5, 195, 222, 0.2); /* Updated shadow color */
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            background: var(--brand-blue-light);
            box-shadow: 0 6px 15px rgba(5, 195, 222, 0.3); /* Updated shadow color */
        }

        .btn-secondary {
            background-color: #e8e8ed;
            color: var(--text-primary);
            padding: 16px 24px;
        }
        .btn-secondary:hover { background-color: #dcdce1; }
        
        .btn-dark {
            background-color: #333;
            color: white;
        }
        .btn-dark:hover {
            background-color: #555;
        }

        .btn-remove {
            background-color: #ffe5e9;
            color: var(--error-color);
            padding: 8px 14px;
            font-size: 0.8rem;
        }
        .btn-remove:hover { background-color: var(--error-color); color: white; }
        
        .btn-edit {
            background-color: #e6f7ff;
            color: #00609a;
            padding: 8px 14px;
            font-size: 0.8rem;
        }
        .btn-edit:hover { background-color: #ccefff; }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .checkbox-group label {
            font-weight: 500;
            color: var(--text-primary);
            flex-grow: 1;
        }
        
        .custom-add-form {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }

        table {
            width: 100%; border-collapse: separate; border-spacing: 0;
            margin: 25px 0;
        }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid #f0f0f2;}
        thead th {
            background-color: var(--card-bg-color);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
            border-top: 1px solid #f0f0f2;
        }
        tbody tr:last-child td { border-bottom: none; }
        td.actions-cell {
            display: flex;
            gap: 8px;
        }

        /* Style for draggable rows */
        tbody tr {
            cursor: grab;
        }
        .sortable-ghost {
            background: #e6f7ff;
            opacity: 0.7;
        }
        .sortable-drag {
            cursor: grabbing;
        }
        
        #itinerary { animation: fadeIn 0.8s ease-in-out; }
        .itinerary-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            background-color: var(--bg-color);
            padding: 25px;
            border-radius: var(--radius-l);
            margin-bottom: 30px;
        }
        .summary-item { display: flex; align-items: center; gap: 12px; }
        .summary-item .icon { font-size: 1.5rem; color: var(--brand-blue); }
        .summary-item div { font-size: 0.9rem; }
        .summary-item strong { color: var(--text-primary); font-weight: 600; display: block; }
        .summary-item span { color: var(--text-secondary); }

        .total {
            font-size: 1.8rem;
            font-weight: 700;
            text-align: right;
            margin-top: 20px;
            padding: 20px 0;
            border-top: 1px solid var(--border-color);
        }
        .total span { color: var(--text-secondary); font-weight: 500; }

        .hidden { display: none; }

        #error-display {
            background-color: #fff0f2; color: var(--error-color);
            padding: 15px; border-radius: var(--radius-m);
            border-left: 5px solid var(--error-color);
            margin-bottom: 20px; text-align: center; font-weight: 600;
            animation: fadeIn 0.3s ease-out;
        }
        
        .day-timeline {
            position: relative;
            padding: 20px 0;
            margin-top: 40px; 
        }
        .day-timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 40px; 
            height: calc(100% - 80px); 
            width: 2px;
            background: #e8e8ed;
        }
        .day-entry {
            position: relative;
            margin-left: 60px;
            margin-bottom: 30px;
            background: var(--bg-color);
            border-radius: var(--radius-l);
            padding: 20px;
        }
        .day-entry:first-child::before {
            top: 18px; 
        }

        .day-entry::before {
            content: attr(data-day);
            position: absolute;
            left: -58px; top: 18px;
            width: 36px; height: 36px;
            background: var(--brand-blue);
            color: white;
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-weight: 700;
            border: 4px solid var(--card-bg-color);
        }
        .day-entry h4 { margin: 0 0 15px 0; font-weight: 700; }
        .day-item-list { list-style-type: none; padding-left: 0; }
        .day-item-list li {
            display: flex; gap: 15px;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e3;
        }
        .day-item-list li:last-child { border-bottom: none; }
        .day-item-list .icon { font-size: 1.2rem; color: var(--brand-blue); line-height: 1.6; }
        .day-item-list .item-details { display: flex; flex-direction: column; }
        .day-item-list .item-title { font-weight: 600; }
        .day-item-list .item-location { font-size: 0.9rem; color: var(--text-secondary); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        @keyframes slideUp {
            from { opacity: 1; transform: translateX(-50%) translateY(0); }
            to { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }
    </style>
</head>
<body>
    <!-- Authentication Section -->
    <div id="authSection" class="auth-section">
        <div class="auth-overlay">
            <div class="auth-card">
                <div class="auth-header">
                    <h1>🌍 Travelverse</h1>
                    <p>Your Personal Travel Planning Assistant</p>
                </div>
                <div class="auth-content">
                    <h2>Welcome to Travelverse</h2>
                    <p>Sign in to save and manage your travel itineraries</p>
                    <div class="auth-buttons">
                        <div id="g_id_onload"
                             data-client_id="359915756783-i8ccoerqfh4ht7nfkva3qm5bi6kkjf2j.apps.googleusercontent.com"
                             data-context="signin"
                             data-ux_mode="popup"
                             data-callback="handleCredentialResponse"
                             data-auto_prompt="false">
                        </div>
                        <div class="g_id_signin"
                             data-type="standard"
                             data-shape="rectangular"
                             data-theme="outline"
                             data-text="signin_with"
                             data-size="large"
                             data-logo_alignment="left">
                        </div>
                        <div class="auth-note">
                            <small>⚠️ For testing, you can also use "Continue as Guest"</small>
                        </div>
                        <button class="google-signin-btn" onclick="signInWithGoogle()" style="display: none;">
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHZpZXdCb3g9IjAgMCAxOCAxOCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE3LjY0IDkuMjA0NTVDMTcuNjQgOC41NjY0IDE3LjU4MjcgOC4wMTM2NCAxNy40NzY0IDcuNDgxODJIMTlWMTQuMjU0NUgxNy42NFY5LjIwNDU1WiIgZmlsbD0iI0Y0QjQwNCIvPgo8cGF0aCBkPSJNMTMuNzI3MyAxMy4wNDU1QzEzLjQ1NDUgMTMuNTgxOCAxMy4wNzI3IDE0LjA0NTUgMTIuNTgxOCAxNC4zNzI3QzEyLjA5MDkgMTQuNzAwIDEwLjU0NTUgMTUuMzYzNiA5LjU0NTQ1IDE1LjM2MzZDOC4wOTA5MSAxNS4zNjM2IDYuNzI3MjcgMTQuNjM2NCA1Ljk1NDU1IDEzLjQ1NDVDNS4xODE4MiAxMi4yNzI3IDQuNzI3MjcgMTAuNzI3MyA0LjcyNzI3IDkuMDkwOTFDNC43MjcyNyA3LjQ1NDU1IDUuMTgxODIgNS45MDkwOSA1Ljk1NDU1IDQuNzI3MjdDNi43MjcyNyAzLjU0NTQ1IDguMDkwOTEgMi44MTgxOCA5LjU0NTQ1IDIuODE4MThDMTEuMDkwOSAyLjgxODE4IDEyLjA5MDkgMy4zNjM2NCAxMi41ODE4IDMuNzI3MjdDMTMuMDcyNyA0LjA5MDkxIDEzLjQ1NDUgNC41NDU0NSAxMy43MjczIDUuMDkwOTFMMTYuMzYzNiAyLjQ1NDU1QzE1LjU0NTUgMS4zNjM2NCAxNC4yNzI3IDAuNTQ1NDU1IDEyLjgxODE4IDAuNTQ1NDU1QzEwLjgxODE4IDAuNTQ1NDU1IDkuMTgxODIgMS4zNjM2NCA4LjA5MDkxIDIuNzI3MjdDNi45OTk5MSA0LjA5MDkxIDYuMzYzNjQgNS44MTgxOCA2LjM2MzY0IDcuNzI3MjdDNi4zNjM2NCA5LjYzNjM2IDYuOTk5OTEgMTEuMzYzNiA4LjA5MDkxIDEyLjcyNzNDOS4xODE4MiAxNC4wOTA5IDEwLjgxODE4IDE0LjkwOTEgMTIuODE4MTggMTQuOTA5MUMxNC4yNzI3IDE0LjkwOTEgMTUuNTQ1NSAxNC4wOTA5IDE2LjM2MzYgMTIuOTA5MUwxNy42NCA5LjIwNDU1WiIgZmlsbD0iI0Y0QjQwNCIvPgo8L3N2Zz4K" alt="Google" class="google-icon">
                            Sign in with Google
                        </button>
                        <button class="guest-btn" onclick="continueAsGuest()">
                            Continue as Guest
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Section -->
    <div id="userProfile" class="user-profile hidden">
        <div class="user-info">
            <img id="userAvatar" src="" alt="User Avatar" class="user-avatar">
            <div class="user-details">
                <span id="userName" class="user-name"></span>
                <span id="userEmail" class="user-email"></span>
            </div>
        </div>
        <div class="user-actions">
            <button class="profile-btn" onclick="showUserDashboard()" title="My Dashboard">📊</button>
            <button class="logout-btn" onclick="signOut()" title="Sign Out">🚪</button>
        </div>
    </div>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
        <span class="icon" id="themeIcon">🌙</span>
    </button>



    <div class="container">
        <header>
            <h1>Travelverse Itinerary Planner</h1>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <span class="progress-text" id="progressText">0% Complete</span>
            </div>
        </header>
        <div class="section-controls">
            <button class="section-control-btn" onclick="toggleAllSections(true)">📖 Expand All Sections</button>
            <button class="section-control-btn" onclick="toggleAllSections(false)">📚 Collapse All Sections</button>
        </div>

        <div id="error-display" class="hidden"></div>
        
        <!-- FORM SECTIONS -->
        <div class="card collapsible" id="travelerDetailsCard">
            <div class="card-header" onclick="toggleSection('travelerDetailsCard')">
                <h2>👤 Traveler Details</h2>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="card-content">
            <div class="form-row">
                <div class="form-group">
                    <label for="clientName">Full Name</label>
                    <input type="text" id="clientName" placeholder="e.g., Jane Doe">
                </div>
                <div class="form-group">
                    <label for="clientEmail">Email</label>
                    <input type="email" id="clientEmail" placeholder="your@email.com">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="form-group">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate">
                </div>
                <div class="form-group">
                    <label for="country">Country</label>
                    <input type="text" id="country" placeholder="e.g., Italy">
                </div>
            </div>
            <p><strong>Number of Nights:</strong> <span id="nightsDisplay">0</span></p>
            <div class="form-group" style="margin-top: 20px;">
                <label for="place">Places to Travel</label>
                <div class="place-form" style="display:flex; gap:10px;">
                    <input type="text" id="place" placeholder="e.g., Rome">
                    <button id="addPlaceBtn" class="btn-secondary" onclick="addPlace()">Add Place</button>
                </div>
                <div id="placesList" style="margin-top:15px;"></div>
            </div>
            <div class="form-row" style="margin-top: 20px;">
                <div class="form-group">
                    <label for="adults">Adults</label>
                    <input type="number" id="adults" placeholder="1" min="1" value="1">
                </div>
                <div class="form-group">
                    <label for="kids">Kids</label>
                    <input type="number" id="kids" placeholder="0" min="0" value="0" oninput="updateKidsAges()">
                </div>
            </div>
            <div id="kidsAgesContainer" class="form-row"></div>
            </div>
        </div>

        <div class="card collapsible" id="flightDetailsCard">
            <div class="card-header" onclick="toggleSection('flightDetailsCard')">
                <h2>✈️ Flight Details</h2>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="card-content">
            <div class="form-row">
                <div class="form-group">
                    <label for="airline">Airline</label>
                    <input type="text" id="airline" placeholder="Enter airline name">
                </div>
                <div class="form-group">
                    <label for="departure">Departure City</label>
                    <input type="text" id="departure" placeholder="e.g., New York">
                </div>
                <div class="form-group">
                    <label for="arrival">Arrival City</label>
                    <input type="text" id="arrival" placeholder="e.g., Rome">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="flightDate">Flight Date</label>
                    <input type="date" id="flightDate">
                </div>
                <div class="form-group">
                    <label for="flightCost">Cost (₹)</label>
                    <input type="number" id="flightCost" placeholder="0.00" min="0">
                </div>
                <div class="form-group">
                    <label for="flightDescription">Description</label>
                    <input type="text" id="flightDescription" placeholder="e.g., 1 stop, 25 Kgs Baggage">
                </div>
            </div>
            <div id="flightActions" class="action-buttons">
                <button class="btn-secondary" onclick="addFlight()">+ Add Flight</button>
            </div>
            </div>
        </div>
        
        <div class="card collapsible" id="trainDetailsCard">
            <div class="card-header" onclick="toggleSection('trainDetailsCard')">
                <h2>🚆 Train Details</h2>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="card-content">
            <div class="form-row">
                <div class="form-group">
                    <label for="trainName">Train Name/Operator</label>
                    <input type="text" id="trainName" placeholder="e.g., Eurostar">
                </div>
                <div class="form-group">
                    <label for="trainDate">Date</label>
                    <input type="date" id="trainDate">
                </div>
                <div class="form-group">
                    <label for="trainTime">Time</label>
                    <input type="time" id="trainTime">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="trainDescription">Description</label>
                    <input type="text" id="trainDescription" placeholder="e.g., Paris to London, First Class">
                </div>
                 <div class="form-group">
                    <label for="trainCost">Cost (₹)</label>
                    <input type="number" id="trainCost" placeholder="0.00" min="0">
                </div>
            </div>
            <div id="trainActions" class="action-buttons">
                <button class="btn-secondary" onclick="addTrain()">+ Add Train</button>
            </div>
        </div>

        <div class="card collapsible">
            <h2>🚌 Bus Details</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="busName">Bus Name/Operator</label>
                    <input type="text" id="busName" placeholder="e.g., FlixBus">
                </div>
                <div class="form-group">
                    <label for="busDate">Date</label>
                    <input type="date" id="busDate">
                </div>
                 <div class="form-group">
                    <label for="busCost">Cost (₹)</label>
                    <input type="number" id="busCost" placeholder="0.00" min="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group full-width">
                    <label for="busDescription">Description</label>
                    <input type="text" id="busDescription" placeholder="e.g., Rome to Florence, scenic route">
                </div>
            </div>
            <div id="busActions" class="action-buttons">
                <button class="btn-secondary" onclick="addBus()">+ Add Bus</button>
            </div>
        </div>
        
        <div class="card collapsible">
            <h2>🚗 Airport/Train Station Transfers</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="transferName">Transfer Name</label>
                    <input type="text" id="transferName" placeholder="e.g., Airport Pickup">
                </div>
                <div class="form-group">
                    <label for="transferType">Transfer Type</label>
                    <select id="transferType">
                        <option value="Private Car">Private Car</option>
                        <option value="Shuttle Bus">Shuttle Bus</option>
                        <option value="Train">Train</option>
                        <option value="Taxi">Taxi</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transferCost">Cost (₹)</label>
                    <input type="number" id="transferCost" placeholder="0.00" min="0">
                </div>
            </div>
            <div id="transferActions" class="action-buttons">
                <button class="btn-secondary" onclick="addTransfer()">+ Add Transfer</button>
            </div>
        </div>

        <div class="card collapsible">
            <h2>🏨 Hotel Accommodations</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="hotelName">Hotel Name</label>
                    <input type="text" id="hotelName" placeholder="e.g., Colosseum Hotel">
                </div>
                <div class="form-group">
                    <label for="hotelLocation">Location</label>
                    <input type="text" id="hotelLocation" placeholder="e.g., Rome">
                </div>
                <div class="form-group">
                    <label for="roomCategory">Room Category</label>
                    <input type="text" id="roomCategory" placeholder="e.g., Deluxe Room">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="checkIn">Check-In Date</label>
                    <input type="date" id="checkIn">
                </div>
                <div class="form-group">
                    <label for="checkOut">Check-Out Date</label>
                    <input type="date" id="checkOut" disabled>
                </div>
                <div class="form-group">
                    <label for="hotelCost">Total Cost (₹)</label>
                    <input type="number" id="hotelCost" placeholder="0.00" min="0">
                </div>
            </div>
            <div id="hotelActions" class="action-buttons">
                <button class="btn-secondary" onclick="addHotel()">+ Add Hotel</button>
            </div>
        </div>

        <div class="card collapsible">
            <h2>🏞️ Activities & Tours</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="activityName">Activity Name</label>
                    <input type="text" id="activityName" placeholder="e.g., Colosseum Tour">
                </div>
                <div class="form-group">
                    <label for="activityLocation">Location</label>
                    <input type="text" id="activityLocation" placeholder="e.g., Rome">
                </div>
                <div class="form-group">
                    <label for="activityDate">Date</label>
                    <input type="date" id="activityDate">
                </div>
                 <div class="form-group">
                    <label for="activityCost">Cost (₹)</label>
                    <input type="number" id="activityCost" placeholder="0.00" min="0">
                </div>
            </div>
             <div class="form-row">
                <div class="form-group full-width">
                    <label for="activityDescription">Description</label>
                    <input type="text" id="activityDescription" placeholder="e.g., Private tour with guide">
                </div>
            </div>
            <div id="activityActions" class="action-buttons">
                <button class="btn-secondary" onclick="addActivity()">+ Add Activity</button>
            </div>
        </div>
        
        <div class="card collapsible">
            <h2>🌤️ Weather & Travel Info</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="weatherLocation">Location for Weather</label>
                    <input type="text" id="weatherLocation" placeholder="e.g., Rome, Italy" onchange="fetchWeather()">
                </div>
                <div class="form-group">
                    <label for="currencyFrom">Currency Converter</label>
                    <select id="currencyFrom" onchange="convertCurrency()">
                        <option value="INR">Indian Rupee (INR)</option>
                        <option value="USD">US Dollar (USD)</option>
                        <option value="EUR">Euro (EUR)</option>
                        <option value="GBP">British Pound (GBP)</option>
                        <option value="JPY">Japanese Yen (JPY)</option>
                        <option value="AUD">Australian Dollar (AUD)</option>
                        <option value="CAD">Canadian Dollar (CAD)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="currencyTo">To Currency</label>
                    <select id="currencyTo" onchange="convertCurrency()">
                        <option value="USD">US Dollar (USD)</option>
                        <option value="EUR">Euro (EUR)</option>
                        <option value="INR">Indian Rupee (INR)</option>
                        <option value="GBP">British Pound (GBP)</option>
                        <option value="JPY">Japanese Yen (JPY)</option>
                        <option value="AUD">Australian Dollar (AUD)</option>
                        <option value="CAD">Canadian Dollar (CAD)</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="currencyAmount">Amount</label>
                    <input type="number" id="currencyAmount" placeholder="1000" value="1000" oninput="convertCurrency()">
                </div>
                <div class="form-group">
                    <label for="convertedAmount">Converted Amount</label>
                    <input type="text" id="convertedAmount" readonly>
                </div>
                <div class="form-group">
                    <label for="insuranceType">Travel Insurance Type</label>
                    <select id="insuranceType" onchange="calculateInsurance()">
                        <option value="basic">Basic Coverage</option>
                        <option value="standard">Standard Coverage</option>
                        <option value="premium">Premium Coverage</option>
                        <option value="family">Family Coverage</option>
                    </select>
                </div>
            </div>
            <div id="weatherDisplay" class="weather-container"></div>
            <div id="insuranceDisplay" class="insurance-container"></div>
        </div>



        <div class="card collapsible">
            <h2>💰 Costing & Margin</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="marginCost">Margin (₹)</label>
                    <input type="number" id="marginCost" placeholder="e.g., 10000.00" min="0">
                </div>
            </div>
        </div>





        <div class="card collapsible">
            <h2>📦 Inclusions & Exclusions</h2>
            <div class="form-row" style="grid-template-columns: 1fr 1fr; gap: 40px;">
                <div>
                    <h3>Inclusions</h3>
                    <div id="inclusionsList"></div>
                    <div class="custom-add-form">
                        <input type="text" id="customInclusion" placeholder="Add custom inclusion">
                        <button class="btn-secondary" onclick="addInclusionExclusion('inclusion')">Add</button>
                    </div>
                </div>
                <div>
                    <h3>Exclusions</h3>
                    <div id="exclusionsList"></div>
                    <div class="custom-add-form">
                        <input type="text" id="customExclusion" placeholder="Add custom exclusion">
                        <button class="btn-secondary" onclick="addInclusionExclusion('exclusion')">Add</button>
                    </div>
                </div>
            </div>
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn-secondary" onclick="resetInclusionsExclusions()">🔄 Reset to Default</button>
            </div>
        </div>
        
        <div class="card collapsible">
            <h2>⏰ Time Zone Calculator</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="timezoneFrom">From Time Zone</label>
                    <select id="timezoneFrom" onchange="calculateTimeZones()">
                        <option value="Asia/Kolkata">India (IST)</option>
                        <option value="America/New_York">New York (EST)</option>
                        <option value="Europe/London">London (GMT)</option>
                        <option value="Europe/Paris">Paris (CET)</option>
                        <option value="Asia/Tokyo">Tokyo (JST)</option>
                        <option value="Australia/Sydney">Sydney (AEST)</option>
                        <option value="America/Los_Angeles">Los Angeles (PST)</option>
                        <option value="Asia/Dubai">Dubai (GST)</option>
                        <option value="Asia/Singapore">Singapore (SGT)</option>
                        <option value="Asia/Bangkok">Bangkok (ICT)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="timezoneTo">To Time Zone</label>
                    <select id="timezoneTo" onchange="calculateTimeZones()">
                        <option value="America/New_York">New York (EST)</option>
                        <option value="Europe/London">London (GMT)</option>
                        <option value="Europe/Paris">Paris (CET)</option>
                        <option value="Asia/Kolkata">India (IST)</option>
                        <option value="Asia/Tokyo">Tokyo (JST)</option>
                        <option value="Australia/Sydney">Sydney (AEST)</option>
                        <option value="America/Los_Angeles">Los Angeles (PST)</option>
                        <option value="Asia/Dubai">Dubai (GST)</option>
                        <option value="Asia/Singapore">Singapore (SGT)</option>
                        <option value="Asia/Bangkok">Bangkok (ICT)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="timeInput">Time</label>
                    <input type="time" id="timeInput" onchange="calculateTimeZones()">
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn-secondary" onclick="calculateTimeZones()">⏰ Calculate Time</button>
                <button class="btn-secondary" onclick="addTimeZoneAlerts()">⏰ Add Time Alerts</button>
                <button class="btn-secondary" onclick="showWorldClock()">🌍 World Clock</button>
            </div>
            <div id="timezoneDisplay" class="timezone-container"></div>
        </div>

        <div class="card collapsible">
            <h2>🛂 Visa & Travel Requirements</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="visaCountry">Destination Country</label>
                    <select id="visaCountry" onchange="checkVisaRequirements()">
                        <option value="">Select Country</option>
                        <option value="USA">United States</option>
                        <option value="UK">United Kingdom</option>
                        <option value="Schengen">Schengen Area (Europe)</option>
                        <option value="Australia">Australia</option>
                        <option value="Canada">Canada</option>
                        <option value="Japan">Japan</option>
                        <option value="Singapore">Singapore</option>
                        <option value="Thailand">Thailand</option>
                        <option value="Dubai">Dubai/UAE</option>
                        <option value="Maldives">Maldives</option>
                        <option value="Nepal">Nepal</option>
                        <option value="Bhutan">Bhutan</option>
                        <option value="Sri Lanka">Sri Lanka</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="visaPurpose">Purpose of Visit</label>
                    <select id="visaPurpose" onchange="checkVisaRequirements()">
                        <option value="">Select Purpose</option>
                        <option value="tourism">Tourism</option>
                        <option value="business">Business</option>
                        <option value="study">Study</option>
                        <option value="work">Work</option>
                        <option value="family">Family Visit</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="visaDuration">Duration of Stay</label>
                    <select id="visaDuration" onchange="checkVisaRequirements()">
                        <option value="">Select Duration</option>
                        <option value="short">Short Stay (0-90 days)</option>
                        <option value="medium">Medium Stay (3-6 months)</option>
                        <option value="long">Long Stay (6+ months)</option>
                    </select>
                </div>
            </div>
            <div id="visaDisplay" class="visa-container"></div>
        </div>

        <div class="card collapsible">
            <h2>📋 Template Management</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="templateName">Template Name</label>
                    <input type="text" id="templateName" placeholder="e.g., Italy Summer Package">
                </div>
                <div class="form-group">
                    <label for="templateDescription">Description</label>
                    <input type="text" id="templateDescription" placeholder="e.g., 7-day Italy tour with flights and hotels">
                </div>
            </div>
            <div class="action-buttons">
                                    <button class="btn-secondary" onclick="saveAsTemplate()">💾 Save as Template</button>
                    <button onclick="saveCurrentItinerary()" class="btn btn-success" id="saveItineraryBtn" style="display: none;">💾 Save Itinerary</button>
                <button class="btn-secondary" onclick="loadTemplate()">📂 Load Template</button>
                <button class="btn-secondary" onclick="showTemplates()">📋 View All Templates</button>
            </div>
        </div>

        <button class="btn-primary" onclick="generateItinerary(true)">Generate Travel Plan</button>

        <!-- ITINERARY OUTPUT SECTION -->
        <div id="itinerary" class="hidden">
            <div class="card collapsible">
                <h2>Trip Summary</h2>
                <div class="itinerary-summary">
                    <div class="summary-item"><span class="icon">👤</span><div><strong>Name</strong><span id="itineraryClientName"></span></div></div>
                    <div class="summary-item"><span class="icon">📧</span><div><strong>Email</strong><span id="itineraryClientEmail"></span></div></div>
                    <div class="summary-item"><span class="icon">📅</span><div><strong>Travel Dates</strong><span id="itineraryTravelDates"></span></div></div>
                    <div class="summary-item"><span class="icon">🌍</span><div><strong>Country</strong><span id="itineraryCountry"></span></div></div>
                    <div class="summary-item"><span class="icon">📍</span><div><strong>Places</strong><span id="itineraryPlaces"></span></div></div>
                    <div class="summary-item"><span class="icon">🌙</span><div><strong>Nights</strong><span id="itineraryNights"></span></div></div>
                    <div class="summary-item"><span class="icon">👥</span><div><strong>Travelers</strong><span id="itineraryTravelers"></span></div></div>
                </div>
                
                <div id="flights_section">
                    <h2>Flights</h2>
                    <table id="flightsTable">
                        <thead>
                            <tr><th>Airline</th><th>From</th><th>To</th><th>Date</th><th>Cost</th><th>Action</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="trains_section">
                    <h2>Trains</h2>
                    <table id="trainsTable">
                        <thead>
                            <tr><th>Operator</th><th>Date</th><th>Time</th><th>Description</th><th>Cost</th><th>Action</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="buses_section">
                    <h2>Buses</h2>
                    <table id="busesTable">
                        <thead>
                            <tr><th>Operator</th><th>Date</th><th>Description</th><th>Cost</th><th>Action</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                 <div id="transfers_section">
                    <h2>Transfers</h2>
                    <table id="transfersTable">
                        <thead>
                            <tr><th>Name</th><th>Type</th><th>Cost</th><th>Action</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="hotels_section">
                    <h2>Hotels</h2>
                    <table id="hotelsTable">
                        <thead>
                            <tr><th>Name</th><th>Location</th><th>Room Category</th><th>Check-In</th><th>Check-Out</th><th>Total Cost</th><th>Action</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="activities_section">
                    <h2>Activities</h2>
                    <table id="activitiesTable">
                        <thead>
                            <tr><th>Activity</th><th>Description</th><th>Date</th><th>Cost</th><th>Action</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="daywise_section">
                    <h2>Day-wise Itinerary</h2>
                    <div id="dayWiseItinerary" class="day-timeline"></div>
                </div>
                
                <div id="inc_exc_section_html" class="hidden">
                     <div class="form-row" style="grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 30px;">
                        <div>
                            <h3 style="font-size: 1.3rem;">Inclusions</h3>
                            <ul id="inclusionsListHtml" style="list-style-position: inside; padding-left: 10px; color: var(--text-secondary);"></ul>
                        </div>
                        <div>
                            <h3 style="font-size: 1.3rem;">Exclusions</h3>
                            <ul id="exclusionsListHtml" style="list-style-position: inside; padding-left: 10px; color: var(--text-secondary);"></ul>
                        </div>
                    </div>
                </div>

                <div class="total">
                    <span>Total Estimated Cost: </span>₹<span id="totalCost">0.00</span>
                </div>

                        <div class="card collapsible">
            <h2>📄 Enhanced PDF Options</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="pdfLanguage">PDF Language</label>
                    <select id="pdfLanguage">
                        <option value="en">English</option>
                        <option value="hi">हिंदी (Hindi)</option>
                        <option value="es">Español (Spanish)</option>
                        <option value="fr">Français (French)</option>
                        <option value="de">Deutsch (German)</option>
                        <option value="it">Italiano (Italian)</option>
                        <option value="pt">Português (Portuguese)</option>
                        <option value="ar">العربية (Arabic)</option>
                        <option value="zh">中文 (Chinese)</option>
                        <option value="ja">日本語 (Japanese)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pdfTheme">PDF Theme</label>
                    <select id="pdfTheme">
                        <option value="default">Default Theme</option>
                        <option value="premium">Premium Theme</option>
                        <option value="minimal">Minimal Theme</option>
                        <option value="corporate">Corporate Theme</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="customColors">Custom Brand Colors (Hex)</label>
                    <input type="text" id="customColors" placeholder="#05C3DE,#4ee0f0" title="Primary,Secondary colors separated by comma">
                </div>
            </div>
        </div>

        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px;">
            <button class="btn-primary" onclick="downloadPDF('client')" style="flex-grow: 1;">📄 Download Client Quote</button>
            <button class="btn-dark" onclick="downloadPDF('business')" style="flex-grow: 1;">📈 Download Business Copy</button>
            <button class="btn-secondary" onclick="downloadPDF('premium')" style="flex-grow: 1;">⭐ Premium PDF</button>
            <button class="btn-secondary" onclick="shareItinerary()" style="flex-grow: 1;">📤 Share Itinerary</button>
            <button class="btn-secondary" onclick="exportToJSON()" style="flex-grow: 1;">💾 Export Data</button>
        </div>
            </div>
        </div>
    </div>

    <script>
        // --- AUTHENTICATION STATE ---
        let currentUser = null;
        let isAuthenticated = false;

        // --- DATA STATE AND ALL UI LOGIC ---
        let flights = [], trains = [], buses = [], hotels = [], activities = [], places = [], inclusions = [], exclusions = [], transfers = [];
        let currentlyEditing = null; // { type: 'flight', index: 0 }
        const errorDisplay = document.getElementById("error-display");
        
        // Authentication Functions
        function initializeAuth() {
            // Check if user is already signed in
            const savedUser = localStorage.getItem('travelverse_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                isAuthenticated = true;
                showAuthenticatedUI();
            } else {
                showAuthUI();
            }
        }

        function signInWithGoogle() {
            // Initialize Google Sign-In
            if (typeof google !== 'undefined' && google.accounts) {
                google.accounts.oauth2.initTokenClient({
                    client_id: '359915756783-i8ccoerqfh4ht7nfkva3qm5bi6kkjf2j.apps.googleusercontent.com', // Replace with your actual Client ID
                    scope: 'openid email profile',
                    callback: function(response) {
                        if (response.access_token) {
                            // Get user info using the access token
                            fetchUserInfo(response.access_token);
                        }
                    }
                }).requestAccessToken();
            } else {
                // Fallback to demo mode if Google API is not available
                console.log('Google API not available, using demo mode');
                const mockUser = {
                    id: 'user_' + Date.now(),
                    name: 'Demo User',
                    email: 'demo@travelverse.com',
                    picture: 'https://via.placeholder.com/40x40/05C3DE/ffffff?text=U'
                };
                handleUserLogin(mockUser);
            }
        }

        function fetchUserInfo(accessToken) {
            fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => response.json())
            .then(userData => {
                const user = {
                    id: userData.id,
                    name: userData.name,
                    email: userData.email,
                    picture: userData.picture
                };
                handleUserLogin(user);
            })
            .catch(error => {
                console.error('Error fetching user info:', error);
                showNotification('Failed to sign in with Google. Please try again.', 'error');
            });
        }

        function handleCredentialResponse(response) {
            // Decode the JWT token to get user information
            const responsePayload = decodeJwtResponse(response.credential);
            
            const user = {
                id: responsePayload.sub,
                name: responsePayload.name,
                email: responsePayload.email,
                picture: responsePayload.picture
            };
            
            handleUserLogin(user);
        }

        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        function handleUserLogin(user) {
            currentUser = user;
            isAuthenticated = true;
            
            // Save user data
            localStorage.setItem('travelverse_user', JSON.stringify(user));
            
            // Load user-specific data
            loadUserData(user.id);
            
            // Show authenticated UI
            showAuthenticatedUI();
            
            showNotification(`Welcome back, ${user.name}!`, 'success');
        }

        function continueAsGuest() {
            const guestUser = {
                id: 'guest_' + Date.now(),
                name: 'Guest User',
                email: 'guest@travelverse.com',
                picture: 'https://via.placeholder.com/40x40/999999/ffffff?text=G'
            };
            
            handleUserLogin(guestUser);
        }

        function signOut() {
            currentUser = null;
            isAuthenticated = false;
            
            // Clear user data
            localStorage.removeItem('travelverse_user');
            
            // Clear current session data
            clearCurrentSession();
            
            // Show auth UI
            showAuthUI();
            
            showNotification('Signed out successfully', 'success');
        }

        function showAuthUI() {
            document.getElementById('authSection').style.display = 'flex';
            document.getElementById('userProfile').classList.add('hidden');
            document.querySelector('.container').style.display = 'none';
            document.getElementById('saveItineraryBtn').style.display = 'none';
        }

        function showAuthenticatedUI() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('userProfile').classList.remove('hidden');
            document.querySelector('.container').style.display = 'block';
            document.getElementById('saveItineraryBtn').style.display = 'inline-block';
            
            // Update user profile display
            updateUserProfile();
        }

        function updateUserProfile() {
            if (currentUser) {
                document.getElementById('userAvatar').src = currentUser.picture;
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userEmail').textContent = currentUser.email;
            }
        }

        function loadUserData(userId) {
            // Load user-specific itineraries
            const userItineraries = JSON.parse(localStorage.getItem(`user_${userId}_itineraries`) || '[]');
            const userTemplates = JSON.parse(localStorage.getItem(`user_${userId}_templates`) || '[]');
            
            // For now, we'll just load the most recent itinerary if any
            if (userItineraries.length > 0) {
                const latestItinerary = userItineraries[userItineraries.length - 1];
                loadItineraryData(latestItinerary.data);
            }
        }

        function saveUserData() {
            if (currentUser && isAuthenticated) {
                const itineraryData = {
                    clientName: document.getElementById('clientName').value,
                    clientEmail: document.getElementById('clientEmail').value,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    country: document.getElementById('country').value,
                    adults: document.getElementById('adults').value,
                    kids: document.getElementById('kids').value,
                    places: [...places],
                    marginCost: document.getElementById('marginCost').value,
                    flights: [...flights],
                    trains: [...trains],
                    buses: [...buses],
                    transfers: [...transfers],
                    hotels: [...hotels],
                    activities: [...activities],
                    inclusions: [...inclusions],
                    exclusions: [...exclusions],
                    savedAt: new Date().toISOString()
                };

                const userItineraries = JSON.parse(localStorage.getItem(`user_${currentUser.id}_itineraries`) || '[]');
                userItineraries.push({
                    id: Date.now(),
                    data: itineraryData
                });
                
                localStorage.setItem(`user_${currentUser.id}_itineraries`, JSON.stringify(userItineraries));
            }
        }

        function loadItineraryData(data) {
            document.getElementById('clientName').value = data.clientName || '';
            document.getElementById('clientEmail').value = data.clientEmail || '';
            document.getElementById('startDate').value = data.startDate || '';
            document.getElementById('endDate').value = data.endDate || '';
            document.getElementById('country').value = data.country || '';
            document.getElementById('adults').value = data.adults || '1';
            document.getElementById('kids').value = data.kids || '0';
            document.getElementById('marginCost').value = data.marginCost || '';
            
            places = data.places || [];
            flights = data.flights || [];
            trains = data.trains || [];
            buses = data.buses || [];
            transfers = data.transfers || [];
            hotels = data.hotels || [];
            activities = data.activities || [];
            inclusions = data.inclusions || [];
            exclusions = data.exclusions || [];
            
            // Update UI
            renderPlaces();
            renderInclusionsExclusions();
            updateProgress();
        }

        function clearCurrentSession() {
            // Clear form data
            document.getElementById('clientName').value = '';
            document.getElementById('clientEmail').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('country').value = '';
            document.getElementById('adults').value = '1';
            document.getElementById('kids').value = '0';
            document.getElementById('marginCost').value = '';
            
            // Clear arrays
            places = [];
            flights = [];
            trains = [];
            buses = [];
            transfers = [];
            hotels = [];
            activities = [];
            inclusions = [];
            exclusions = [];
            
            // Update UI
            renderPlaces();
            renderInclusionsExclusions();
            updateProgress();
        }

        function showUserDashboard() {
            if (!currentUser) return;
            
            const userItineraries = JSON.parse(localStorage.getItem(`user_${currentUser.id}_itineraries`) || '[]');
            const userTemplates = JSON.parse(localStorage.getItem(`user_${currentUser.id}_templates`) || '[]');
            
            let dashboardHTML = `
                <div class="dashboard-modal">
                    <div class="dashboard-content">
                        <div class="dashboard-header">
                            <h2>📊 My Dashboard</h2>
                            <button onclick="closeDashboard()" class="close-btn">×</button>
                        </div>
                        <div class="dashboard-stats">
                            <div class="stat-card">
                                <h3>${userItineraries.length}</h3>
                                <p>Total Trips</p>
                            </div>
                            <div class="stat-card">
                                <h3>${userTemplates.length}</h3>
                                <p>Saved Templates</p>
                            </div>
                        </div>
                        <div class="dashboard-recent">
                            <h3>Recent Itineraries</h3>
                            ${userItineraries.length > 0 ? 
                                userItineraries.slice(-3).reverse().map(itinerary => `
                                    <div class="itinerary-item" onclick="loadItinerary('${itinerary.id}')">
                                        <div class="itinerary-info">
                                            <h4>${itinerary.data.clientName || 'Unnamed Trip'}</h4>
                                            <p>${itinerary.data.country || 'No destination'} • ${new Date(itinerary.savedAt).toLocaleDateString()}</p>
                                        </div>
                                        <button class="load-btn">Load</button>
                                    </div>
                                `).join('') : 
                                '<p>No itineraries yet. Start planning your first trip!</p>'
                            }
                        </div>
                    </div>
                </div>
            `;
            
            // Create modal
            const modal = document.createElement('div');
            modal.innerHTML = dashboardHTML;
            modal.className = 'dashboard-modal-overlay';
            document.body.appendChild(modal);
        }

        function closeDashboard() {
            const modal = document.querySelector('.dashboard-modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        function loadItinerary(itineraryId) {
            if (!currentUser) return;
            
            const userItineraries = JSON.parse(localStorage.getItem(`user_${currentUser.id}_itineraries`) || '[]');
            const itinerary = userItineraries.find(i => i.id.toString() === itineraryId);
            
            if (itinerary) {
                loadItineraryData(itinerary.data);
                closeDashboard();
                showNotification('Itinerary loaded successfully!', 'success');
            }
        }

        function saveCurrentItinerary() {
            if (!isAuthenticated) {
                showNotification('Please sign in to save your itinerary', 'error');
                return;
            }
            
            saveUserData();
            showNotification('Itinerary saved successfully!', 'success');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Add styles
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10001;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                max-width: 300px;
            `;
            
            // Set background color based on type
            switch(type) {
                case 'success':
                    notification.style.background = '#28a745';
                    break;
                case 'error':
                    notification.style.background = '#dc3545';
                    break;
                case 'warning':
                    notification.style.background = '#ffc107';
                    notification.style.color = '#333';
                    break;
                default:
                    notification.style.background = '#17a2b8';
            }
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Theme Management
        let currentTheme = localStorage.getItem('theme') || 'light';
        
        // Auto-save with debouncing
        let saveTimeout = null;
        const SAVE_DELAY = 1000; // 1 second delay
        
        function debouncedSave() {
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            saveTimeout = setTimeout(() => {
                saveData();
                updateProgress();
            }, SAVE_DELAY);
        }
        
        function updateProgress() {
            const requiredFields = [
                'clientName', 'startDate', 'endDate', 'country'
            ];
            
            const optionalSections = [
                { data: flights, name: 'Flights' },
                { data: trains, name: 'Trains' },
                { data: buses, name: 'Buses' },
                { data: transfers, name: 'Transfers' },
                { data: hotels, name: 'Hotels' },
                { data: activities, name: 'Activities' }
            ];
            
            let completedFields = 0;
            let totalFields = requiredFields.length;
            
            // Check required fields
            requiredFields.forEach(fieldId => {
                const value = document.getElementById(fieldId)?.value;
                if (value && value.trim() !== '') {
                    completedFields++;
                }
            });
            
            // Check optional sections (count as completed if at least one item exists)
            optionalSections.forEach(section => {
                totalFields++;
                if (section.data.length > 0) {
                    completedFields++;
                }
            });
            
            const progress = Math.round((completedFields / totalFields) * 100);
            
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (progressFill && progressText) {
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `${progress}% Complete`;
                
                // Change color based on progress
                if (progress >= 80) {
                    progressFill.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
                } else if (progress >= 50) {
                    progressFill.style.background = 'linear-gradient(90deg, #ffc107, #fd7e14)';
                } else {
                    progressFill.style.background = 'linear-gradient(90deg, var(--brand-blue), var(--brand-blue-light))';
                }
            }
        }
        
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            
            const themeIcon = document.getElementById('themeIcon');
            themeIcon.textContent = currentTheme === 'light' ? '🌙' : '☀️';
        }
        
        function initializeTheme() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            const themeIcon = document.getElementById('themeIcon');
            themeIcon.textContent = currentTheme === 'light' ? '🌙' : '☀️';
        }
        
        // Template Management
        function saveAsTemplate() {
            const templateName = document.getElementById('templateName').value.trim();
            const templateDescription = document.getElementById('templateDescription').value.trim();
            
            if (!templateName) {
                displayError("Please enter a template name.");
                return;
            }
            
            const templateData = {
                name: templateName,
                description: templateDescription,
                data: {
                    clientName: document.getElementById("clientName").value,
                    clientEmail: document.getElementById("clientEmail").value,
                    startDate: document.getElementById("startDate").value,
                    endDate: document.getElementById("endDate").value,
                    country: document.getElementById("country").value,
                    adults: document.getElementById("adults").value,
                    kids: document.getElementById("kids").value,
                    places: [...places],
                    marginCost: document.getElementById("marginCost").value,
                    flights: [...flights],
                    trains: [...trains],
                    buses: [...buses],
                    transfers: [...transfers],
                    hotels: [...hotels],
                    activities: [...activities],
                    inclusions: [...inclusions],
                    exclusions: [...exclusions]
                },
                createdAt: new Date().toISOString()
            };
            
            const templates = JSON.parse(localStorage.getItem('travelTemplates') || '[]');
            templates.push(templateData);
            localStorage.setItem('travelTemplates', JSON.stringify(templates));
            
            document.getElementById('templateName').value = '';
            document.getElementById('templateDescription').value = '';
            
            showNotification('✅ Template saved successfully!', 'success');
        }
        
        function loadTemplate() {
            const templates = JSON.parse(localStorage.getItem('travelTemplates') || '[]');
            if (templates.length === 0) {
                displayError("No templates found. Save a template first.");
                return;
            }
            
            const templateNames = templates.map(t => t.name);
            const selectedTemplate = prompt(`Select a template:\n${templateNames.map((name, i) => `${i + 1}. ${name}`).join('\n')}\n\nEnter the number (1-${templates.length}):`);
            
            if (!selectedTemplate) return;
            
            const index = parseInt(selectedTemplate) - 1;
            if (isNaN(index) || index < 0 || index >= templates.length) {
                displayError("Invalid selection.");
                return;
            }
            
            const template = templates[index];
            loadTemplateData(template.data);
            showNotification(`📂 Loaded template: ${template.name}`, 'success');
        }
        
        function loadTemplateData(data) {
            document.getElementById("clientName").value = data.clientName || '';
            document.getElementById("clientEmail").value = data.clientEmail || '';
            document.getElementById("startDate").value = data.startDate || '';
            document.getElementById("endDate").value = data.endDate || '';
            document.getElementById("country").value = data.country || '';
            document.getElementById("adults").value = data.adults || '1';
            document.getElementById("kids").value = data.kids || '0';
            document.getElementById("marginCost").value = data.marginCost || '';
            
            places = data.places || [];
            flights = data.flights || [];
            trains = data.trains || [];
            buses = data.buses || [];
            transfers = data.transfers || [];
            hotels = data.hotels || [];
            activities = data.activities || [];
            inclusions = data.inclusions || predefinedInclusions.map(text => ({ text, checked: true, custom: false }));
            exclusions = data.exclusions || predefinedExclusions.map(text => ({ text, checked: true, custom: false }));
            
            renderInclusionsExclusions();
            initializeDateLogic();
            updateKidsAges();
            renderPlaces();
            saveData();
        }
        
        function showTemplates() {
            const templates = JSON.parse(localStorage.getItem('travelTemplates') || '[]');
            if (templates.length === 0) {
                displayError("No templates found.");
                return;
            }
            
            let templateList = "📋 Saved Templates:\n\n";
            templates.forEach((template, index) => {
                const date = new Date(template.createdAt).toLocaleDateString();
                templateList += `${index + 1}. ${template.name}\n   📝 ${template.description}\n   📅 Created: ${date}\n\n`;
            });
            
            alert(templateList);
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#d4edda' : '#d1ecf1'};
                color: ${type === 'success' ? '#155724' : '#0c5460'};
                border: 1px solid ${type === 'success' ? '#c3e6cb' : '#bee5eb'};
                border-radius: var(--radius-m);
                padding: 15px 25px;
                box-shadow: var(--shadow);
                z-index: 1001;
                font-weight: 600;
                animation: slideDown 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Sharing and Export Functions
        function shareItinerary() {
            const itineraryData = {
                clientName: document.getElementById("clientName").value,
                country: document.getElementById("country").value,
                startDate: document.getElementById("startDate").value,
                endDate: document.getElementById("endDate").value,
                places: places,
                flights: flights,
                trains: trains,
                buses: buses,
                transfers: transfers,
                hotels: hotels,
                activities: activities,
                totalCost: document.getElementById("totalCost").innerText
            };
            
            const shareText = `Travel Itinerary for ${itineraryData.clientName}
Destination: ${itineraryData.country}
Dates: ${itineraryData.startDate} to ${itineraryData.endDate}
Places: ${itineraryData.places.join(', ')}
Total Cost: ${itineraryData.totalCost}

Generated by Travelverse Itinerary Planner`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Travel Itinerary',
                    text: shareText,
                    url: window.location.href
                }).then(() => {
                    showNotification('✅ Itinerary shared successfully!', 'success');
                }).catch(err => {
                    console.log('Error sharing:', err);
                    copyToClipboard(shareText);
                });
            } else {
                copyToClipboard(shareText);
            }
        }
        
        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('📋 Itinerary copied to clipboard!', 'success');
                }).catch(err => {
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }
        
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showNotification('📋 Itinerary copied to clipboard!', 'success');
            } catch (err) {
                showNotification('❌ Failed to copy to clipboard', 'error');
            }
            document.body.removeChild(textArea);
        }
        
        function exportToJSON() {
            const exportData = {
                metadata: {
                    exportedAt: new Date().toISOString(),
                    version: '1.0',
                    source: 'Travelverse Itinerary Planner'
                },
                itinerary: {
                    clientName: document.getElementById("clientName").value,
                    clientEmail: document.getElementById("clientEmail").value,
                    startDate: document.getElementById("startDate").value,
                    endDate: document.getElementById("endDate").value,
                    country: document.getElementById("country").value,
                    adults: document.getElementById("adults").value,
                    kids: document.getElementById("kids").value,
                    places: places,
                    marginCost: document.getElementById("marginCost").value,
                    flights: flights,
                    trains: trains,
                    buses: buses,
                    transfers: transfers,
                    hotels: hotels,
                    activities: activities,
                    inclusions: inclusions,
                    exclusions: exclusions
                }
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `itinerary_${document.getElementById("clientName").value.replace(/\s/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('💾 Data exported successfully!', 'success');
        }
        
        // Advanced Planning Features
        // Currency conversion rates (simplified - in real app, use API)
        const currencyRates = {
            'INR': { 'USD': 0.012, 'EUR': 0.011, 'GBP': 0.0095, 'JPY': 1.8, 'AUD': 0.018, 'CAD': 0.016 },
            'USD': { 'INR': 83.5, 'EUR': 0.92, 'GBP': 0.79, 'JPY': 150, 'AUD': 1.52, 'CAD': 1.35 },
            'EUR': { 'INR': 90.5, 'USD': 1.09, 'GBP': 0.86, 'JPY': 163, 'AUD': 1.65, 'CAD': 1.47 },
            'GBP': { 'INR': 105.2, 'USD': 1.26, 'EUR': 1.16, 'JPY': 190, 'AUD': 1.92, 'CAD': 1.71 },
            'JPY': { 'INR': 0.55, 'USD': 0.0067, 'EUR': 0.0061, 'GBP': 0.0053, 'AUD': 0.010, 'CAD': 0.009 },
            'AUD': { 'INR': 55.5, 'USD': 0.66, 'EUR': 0.61, 'GBP': 0.52, 'JPY': 98.7, 'CAD': 0.89 },
            'CAD': { 'INR': 62.5, 'USD': 0.74, 'EUR': 0.68, 'GBP': 0.58, 'JPY': 111, 'AUD': 1.12 }
        };
        
        function convertCurrency() {
            const fromCurrency = document.getElementById('currencyFrom').value;
            const toCurrency = document.getElementById('currencyTo').value;
            const amount = parseFloat(document.getElementById('currencyAmount').value) || 0;
            
            if (fromCurrency === toCurrency) {
                document.getElementById('convertedAmount').value = amount.toFixed(2);
                return;
            }
            
            let convertedAmount = amount;
            
            if (currencyRates[fromCurrency] && currencyRates[fromCurrency][toCurrency]) {
                convertedAmount = amount * currencyRates[fromCurrency][toCurrency];
            } else if (currencyRates[toCurrency] && currencyRates[toCurrency][fromCurrency]) {
                convertedAmount = amount / currencyRates[toCurrency][fromCurrency];
            }
            
            document.getElementById('convertedAmount').value = `${convertedAmount.toFixed(2)} ${toCurrency}`;
        }
        
        // Insurance calculation
        const insuranceRates = {
            'basic': { baseRate: 500, perDay: 50, coverage: 'Medical, Trip Cancellation' },
            'standard': { baseRate: 800, perDay: 75, coverage: 'Medical, Trip Cancellation, Baggage' },
            'premium': { baseRate: 1200, perDay: 100, coverage: 'Medical, Trip Cancellation, Baggage, Flight Delay' },
            'family': { baseRate: 1500, perDay: 120, coverage: 'Family Medical, Trip Cancellation, Baggage' }
        };
        
        function calculateInsurance() {
            const insuranceType = document.getElementById('insuranceType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const adults = parseInt(document.getElementById('adults').value) || 1;
            const kids = parseInt(document.getElementById('kids').value) || 0;
            
            if (!startDate || !endDate) {
                document.getElementById('insuranceDisplay').innerHTML = '<div class="error-message">Please select travel dates first</div>';
                return;
            }
            
            const nights = calculateNights(startDate, endDate);
            const rate = insuranceRates[insuranceType];
            const totalTravelers = adults + kids;
            
            let totalCost = rate.baseRate + (rate.perDay * nights);
            if (insuranceType === 'family') {
                totalCost = totalCost * Math.ceil(totalTravelers / 2); // Family rate for 2+ people
            } else {
                totalCost = totalCost * totalTravelers;
            }
            
            const insuranceDisplay = document.getElementById('insuranceDisplay');
            insuranceDisplay.innerHTML = `
                <div class="insurance-info">
                    <div class="insurance-details">
                        <h4>${insuranceType.charAt(0).toUpperCase() + insuranceType.slice(1)} Coverage</h4>
                        <p>${rate.coverage}</p>
                        <p>Duration: ${nights} nights | Travelers: ${adults} adults, ${kids} kids</p>
                    </div>
                    <div class="insurance-price">₹${totalCost.toLocaleString()}</div>
                </div>
            `;
        }
        
        // Weather API (using OpenWeatherMap - you'll need an API key for production)
        async function fetchWeather() {
            const location = document.getElementById('weatherLocation').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!location || !startDate || !endDate) {
                document.getElementById('weatherDisplay').innerHTML = '<div class="error-message">Please enter location and travel dates</div>';
                return;
            }
            
            const weatherDisplay = document.getElementById('weatherDisplay');
            weatherDisplay.innerHTML = '<div class="loading">🌤️ Fetching weather data...</div>';
            
            try {
                // For demo purposes, using mock weather data
                // In production, use: https://api.openweathermap.org/data/2.5/forecast?q=${location}&appid=YOUR_API_KEY
                const mockWeatherData = generateMockWeather(startDate, endDate);
                
                let weatherHTML = '<h4>Weather Forecast for ' + location + '</h4><div class="weather-grid">';
                
                mockWeatherData.forEach(day => {
                    weatherHTML += `
                        <div class="weather-day">
                            <div class="date">${day.date}</div>
                            <div class="temp">${day.temp}°C</div>
                            <div class="condition">${day.condition}</div>
                        </div>
                    `;
                });
                
                weatherHTML += '</div>';
                weatherDisplay.innerHTML = weatherHTML;
                
            } catch (error) {
                weatherDisplay.innerHTML = '<div class="error-message">Unable to fetch weather data. Please try again.</div>';
            }
        }
        
        function generateMockWeather(startDate, endDate) {
            const weatherConditions = ['☀️ Sunny', '⛅ Partly Cloudy', '☁️ Cloudy', '🌧️ Rainy', '❄️ Snowy'];
            const weatherData = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            const nights = calculateNights(startDate, endDate);
            
            for (let i = 0; i <= nights; i++) {
                const currentDate = new Date(start);
                currentDate.setDate(start.getDate() + i);
                
                weatherData.push({
                    date: currentDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
                    temp: Math.floor(Math.random() * 25) + 10, // 10-35°C
                    condition: weatherConditions[Math.floor(Math.random() * weatherConditions.length)]
                });
            }
            
            return weatherData;
        }
        
        // Visa Requirements Database
        const visaRequirements = {
            'USA': {
                tourism: {
                    short: { required: true, type: 'B1/B2 Tourist Visa', processingTime: '3-5 business days', fee: '₹12,000', documents: ['Passport valid for 6 months', 'DS-160 confirmation', 'Photo', 'Bank statements', 'Employment letter'] },
                    medium: { required: true, type: 'B1/B2 Tourist Visa', processingTime: '3-5 business days', fee: '₹12,000', documents: ['Passport valid for 6 months', 'DS-160 confirmation', 'Photo', 'Bank statements', 'Employment letter', 'Travel itinerary'] },
                    long: { required: true, type: 'B1/B2 Tourist Visa', processingTime: '3-5 business days', fee: '₹12,000', documents: ['Passport valid for 6 months', 'DS-160 confirmation', 'Photo', 'Bank statements', 'Employment letter', 'Travel itinerary', 'Invitation letter'] }
                },
                business: {
                    short: { required: true, type: 'B1 Business Visa', processingTime: '3-5 business days', fee: '₹12,000', documents: ['Passport valid for 6 months', 'DS-160 confirmation', 'Photo', 'Business invitation', 'Company documents', 'Bank statements'] },
                    medium: { required: true, type: 'B1 Business Visa', processingTime: '3-5 business days', fee: '₹12,000', documents: ['Passport valid for 6 months', 'DS-160 confirmation', 'Photo', 'Business invitation', 'Company documents', 'Bank statements', 'Travel itinerary'] },
                    long: { required: true, type: 'B1 Business Visa', processingTime: '3-5 business days', fee: '₹12,000', documents: ['Passport valid for 6 months', 'DS-160 confirmation', 'Photo', 'Business invitation', 'Company documents', 'Bank statements', 'Travel itinerary', 'Detailed business plan'] }
                }
            },
            'UK': {
                tourism: {
                    short: { required: true, type: 'Standard Visitor Visa', processingTime: '3 weeks', fee: '₹9,500', documents: ['Passport valid for 6 months', 'Online application', 'Photo', 'Bank statements', 'Employment letter', 'Travel itinerary'] },
                    medium: { required: true, type: 'Standard Visitor Visa', processingTime: '3 weeks', fee: '₹9,500', documents: ['Passport valid for 6 months', 'Online application', 'Photo', 'Bank statements', 'Employment letter', 'Travel itinerary', 'Accommodation details'] },
                    long: { required: true, type: 'Standard Visitor Visa', processingTime: '3 weeks', fee: '₹9,500', documents: ['Passport valid for 6 months', 'Online application', 'Photo', 'Bank statements', 'Employment letter', 'Travel itinerary', 'Accommodation details', 'Invitation letter'] }
                }
            },
            'Schengen': {
                tourism: {
                    short: { required: true, type: 'Schengen Visa', processingTime: '15 days', fee: '₹6,000', documents: ['Passport valid for 3 months', 'Application form', 'Photo', 'Bank statements', 'Employment letter', 'Travel insurance', 'Flight itinerary'] },
                    medium: { required: true, type: 'Schengen Visa', processingTime: '15 days', fee: '₹6,000', documents: ['Passport valid for 3 months', 'Application form', 'Photo', 'Bank statements', 'Employment letter', 'Travel insurance', 'Flight itinerary', 'Accommodation details'] },
                    long: { required: true, type: 'National Visa', processingTime: '1-3 months', fee: '₹8,000', documents: ['Passport valid for 3 months', 'Application form', 'Photo', 'Bank statements', 'Employment letter', 'Travel insurance', 'Flight itinerary', 'Accommodation details', 'Invitation letter'] }
                }
            },
            'Thailand': {
                tourism: {
                    short: { required: false, type: 'Visa on Arrival', processingTime: 'Immediate', fee: '₹2,000', documents: ['Passport valid for 6 months', 'Return ticket', 'Photo', 'Cash for visa fee'] },
                    medium: { required: true, type: 'Tourist Visa', processingTime: '3-5 days', fee: '₹2,500', documents: ['Passport valid for 6 months', 'Application form', 'Photo', 'Bank statements', 'Travel itinerary'] },
                    long: { required: true, type: 'Tourist Visa', processingTime: '3-5 days', fee: '₹2,500', documents: ['Passport valid for 6 months', 'Application form', 'Photo', 'Bank statements', 'Travel itinerary', 'Accommodation details'] }
                }
            },
            'Maldives': {
                tourism: {
                    short: { required: false, type: 'Visa on Arrival', processingTime: 'Immediate', fee: 'Free', documents: ['Passport valid for 6 months', 'Return ticket', 'Hotel booking'] },
                    medium: { required: false, type: 'Visa on Arrival', processingTime: 'Immediate', fee: 'Free', documents: ['Passport valid for 6 months', 'Return ticket', 'Hotel booking'] },
                    long: { required: true, type: 'Tourist Visa', processingTime: '3-5 days', fee: '₹1,500', documents: ['Passport valid for 6 months', 'Application form', 'Photo', 'Bank statements', 'Travel itinerary'] }
                }
            },
            'Nepal': {
                tourism: {
                    short: { required: false, type: 'Visa on Arrival', processingTime: 'Immediate', fee: '₹2,000', documents: ['Passport valid for 6 months', 'Return ticket', 'Photo', 'Cash for visa fee'] },
                    medium: { required: false, type: 'Visa on Arrival', processingTime: 'Immediate', fee: '₹2,000', documents: ['Passport valid for 6 months', 'Return ticket', 'Photo', 'Cash for visa fee'] },
                    long: { required: true, type: 'Tourist Visa', processingTime: '3-5 days', fee: '₹2,500', documents: ['Passport valid for 6 months', 'Application form', 'Photo', 'Bank statements', 'Travel itinerary'] }
                }
            }
        };
        
        function checkVisaRequirements() {
            const country = document.getElementById('visaCountry').value;
            const purpose = document.getElementById('visaPurpose').value;
            const duration = document.getElementById('visaDuration').value;
            
            const visaDisplay = document.getElementById('visaDisplay');
            
            if (!country || !purpose || !duration) {
                visaDisplay.innerHTML = '<div class="error-message">Please select all visa requirement fields</div>';
                return;
            }
            
            const requirements = visaRequirements[country]?.[purpose]?.[duration];
            
            if (!requirements) {
                visaDisplay.innerHTML = '<div class="error-message">Visa information not available for selected combination</div>';
                return;
            }
            
            const statusClass = requirements.required ? 'visa-required' : 
                              requirements.type.includes('on Arrival') ? 'visa-on-arrival' : 'visa-not-required';
            
            const statusText = requirements.required ? 'Visa Required' : 
                             requirements.type.includes('on Arrival') ? 'Visa on Arrival' : 'Visa Not Required';
            
            let visaHTML = `
                <div class="visa-info">
                    <span class="visa-status ${statusClass}">${statusText}</span>
                    <h4>${country} - ${purpose.charAt(0).toUpperCase() + purpose.slice(1)} Visa</h4>
                    <p><strong>Visa Type:</strong> ${requirements.type}</p>
                    <p><strong>Processing Time:</strong> ${requirements.processingTime}</p>
                    <p><strong>Fee:</strong> ${requirements.fee}</p>
                    
                    <div class="visa-details">
                        <h5>Required Documents:</h5>
                        <ul>
                            ${requirements.documents.map(doc => `<li>${doc}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
            
            // Add additional tips
            if (country === 'USA') {
                visaHTML += `
                    <div class="visa-info">
                        <h5>💡 Tips for US Visa:</h5>
                        <ul>
                            <li>Book your appointment well in advance (3-4 months before travel)</li>
                            <li>Prepare for a personal interview at the embassy</li>
                            <li>Show strong ties to India (job, family, property)</li>
                            <li>Be honest and consistent in your application</li>
                        </ul>
                    </div>
                `;
            } else if (country === 'Schengen') {
                visaHTML += `
                    <div class="visa-info">
                        <h5>💡 Tips for Schengen Visa:</h5>
                        <ul>
                            <li>Apply to the embassy of your first entry point</li>
                            <li>Ensure your travel insurance covers the entire stay</li>
                            <li>Book refundable flights and hotels initially</li>
                            <li>Show sufficient funds for your stay</li>
                        </ul>
                    </div>
                `;
            }
            
            visaDisplay.innerHTML = visaHTML;
        }
        
        // Packing List Generator
        const packingItems = {
            essentials: {
                title: '📱 Essentials',
                items: [
                    'Passport & Visa',
                    'Travel Insurance',
                    'Credit/Debit Cards',
                    'Cash (Local Currency)',
                    'Phone & Charger',
                    'Power Bank',
                    'Universal Adapter',
                    'Emergency Contacts'
                ]
            },
            clothing: {
                title: '👕 Clothing',
                items: [
                    'Underwear (3-5 pairs)',
                    'Socks (3-5 pairs)',
                    'T-shirts/Shirts',
                    'Pants/Jeans',
                    'Dress/Formal Wear',
                    'Pajamas',
                    'Swimwear',
                    'Jacket/Sweater'
                ]
            },
            toiletries: {
                title: '🧴 Toiletries',
                items: [
                    'Toothbrush & Toothpaste',
                    'Shampoo & Conditioner',
                    'Soap/Body Wash',
                    'Deodorant',
                    'Hair Brush/Comb',
                    'Razor & Shaving Cream',
                    'Feminine Hygiene Products',
                    'Contact Lenses & Solution'
                ]
            },
            electronics: {
                title: '💻 Electronics',
                items: [
                    'Laptop/Tablet',
                    'Camera',
                    'Headphones',
                    'USB Cables',
                    'Memory Cards',
                    'Portable Speaker',
                    'E-reader'
                ]
            },
            documents: {
                title: '📄 Documents',
                items: [
                    'Flight Tickets',
                    'Hotel Confirmations',
                    'Travel Itinerary',
                    'Vaccination Records',
                    'Medical Prescriptions',
                    'Copies of Important Documents'
                ]
            },
            beach: {
                title: '🏖️ Beach Items',
                items: [
                    'Sunscreen (SPF 50+)',
                    'Beach Towel',
                    'Beach Bag',
                    'Sunglasses',
                    'Beach Hat',
                    'Water Bottle',
                    'Beach Umbrella'
                ]
            },
            hiking: {
                title: '🥾 Hiking Items',
                items: [
                    'Hiking Boots',
                    'Backpack',
                    'Water Bottle',
                    'Energy Bars',
                    'First Aid Kit',
                    'Compass/Map',
                    'Rain Jacket',
                    'Hiking Poles'
                ]
            },
            business: {
                title: '💼 Business Items',
                items: [
                    'Business Cards',
                    'Laptop',
                    'Presentation Materials',
                    'Formal Shoes',
                    'Tie/Belt',
                    'Portfolio',
                    'Meeting Schedule'
                ]
            },
            winter: {
                title: '❄️ Winter Items',
                items: [
                    'Warm Jacket',
                    'Thermal Underwear',
                    'Winter Boots',
                    'Gloves',
                    'Scarf',
                    'Winter Hat',
                    'Hand Warmers'
                ]
            }
        };
        

        
        // Smart Features - Time Zone Calculator
        function calculateTimeZones() {
            const fromTimezone = document.getElementById('timezoneFrom').value;
            const toTimezone = document.getElementById('timezoneTo').value;
            const timeInput = document.getElementById('timeInput').value;
            
            if (!timeInput) {
                showNotification('Please enter a time', 'error');
                return;
            }
            
            const timezoneDisplay = document.getElementById('timezoneDisplay');
            
            try {
                const [hours, minutes] = timeInput.split(':');
                const fromDate = new Date();
                fromDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                const toDate = new Date(fromDate.toLocaleString('en-US', { timeZone: fromTimezone }));
                const convertedTime = toDate.toLocaleString('en-US', { 
                    timeZone: toTimezone,
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const timezoneNames = {
                    'Asia/Kolkata': 'India (IST)',
                    'America/New_York': 'New York (EST)',
                    'Europe/London': 'London (GMT)',
                    'Europe/Paris': 'Paris (CET)',
                    'Asia/Tokyo': 'Tokyo (JST)',
                    'Australia/Sydney': 'Sydney (AEST)',
                    'America/Los_Angeles': 'Los Angeles (PST)',
                    'Asia/Dubai': 'Dubai (GST)',
                    'Asia/Singapore': 'Singapore (SGT)',
                    'Asia/Bangkok': 'Bangkok (ICT)'
                };
                
                const timezoneHTML = `
                    <h4>⏰ Time Zone Conversion</h4>
                    <div class="timezone-grid">
                        <div class="timezone-card">
                            <div class="city">${timezoneNames[fromTimezone]}</div>
                            <div class="time">${timeInput}</div>
                            <div class="date">${fromDate.toLocaleDateString()}</div>
                        </div>
                        <div class="timezone-card">
                            <div class="city">${timezoneNames[toTimezone]}</div>
                            <div class="time">${convertedTime}</div>
                            <div class="date">${toDate.toLocaleDateString()}</div>
                        </div>
                    </div>
                `;
                
                timezoneDisplay.innerHTML = timezoneHTML;
                
            } catch (error) {
                timezoneDisplay.innerHTML = '<div class="error-message">Error calculating time zones. Please try again.</div>';
            }
        }
        
        function addTimeZoneAlerts() {
            showNotification('⏰ Time zone alerts feature coming soon!', 'info');
        }
        
        function showWorldClock() {
            const timezoneDisplay = document.getElementById('timezoneDisplay');
            const cities = [
                { name: 'New York', timezone: 'America/New_York' },
                { name: 'London', timezone: 'Europe/London' },
                { name: 'Paris', timezone: 'Europe/Paris' },
                { name: 'Tokyo', timezone: 'Asia/Tokyo' },
                { name: 'Sydney', timezone: 'Australia/Sydney' },
                { name: 'Dubai', timezone: 'Asia/Dubai' }
            ];
            
            let worldClockHTML = '<h4>🌍 World Clock</h4><div class="timezone-grid">';
            
            cities.forEach(city => {
                const now = new Date();
                const cityTime = now.toLocaleString('en-US', { 
                    timeZone: city.timezone,
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const cityDate = now.toLocaleDateString('en-US', { timeZone: city.timezone });
                
                worldClockHTML += `
                    <div class="timezone-card">
                        <div class="city">${city.name}</div>
                        <div class="time">${cityTime}</div>
                        <div class="date">${cityDate}</div>
                    </div>
                `;
            });
            
            worldClockHTML += '</div>';
            timezoneDisplay.innerHTML = worldClockHTML;
        }
        
        // Enhanced PDF Features - Language Support
        const translations = {
            en: {
                title: 'Travelverse Itinerary Planner',
                clientName: 'Client Name',
                email: 'Email',
                travelDates: 'Travel Dates',
                country: 'Country',
                places: 'Places',
                nights: 'Nights',
                travelers: 'Travelers',
                flights: 'Flights',
                trains: 'Trains',
                buses: 'Buses',
                transfers: 'Transfers',
                hotels: 'Hotels',
                activities: 'Activities',
                inclusions: 'Inclusions',
                exclusions: 'Exclusions',
                totalCost: 'Total Estimated Cost',
                about: 'About Travelverse',
                terms: 'Terms & Conditions',
                downloadApp: 'Download Our On-Trip App',
                tripOverview: 'YOUR TRIP OVERVIEW',
                tripQuote: 'TRIP QUOTE',
                preparedFor: 'Prepared for:',
                daywiseItinerary: 'Day-wise Itinerary',
                day: 'Day',
                page: 'Page',
                of: 'of',
                craftedBy: 'Crafted by Travelverse for',
                whereEveryJourney: 'Where every journey is designed around your vibe.'
            },
            hi: {
                title: 'ट्रैवलवर्स यात्रा योजनाकार',
                clientName: 'ग्राहक का नाम',
                email: 'ईमेल',
                travelDates: 'यात्रा की तारीखें',
                country: 'देश',
                places: 'स्थान',
                nights: 'रातें',
                travelers: 'यात्री',
                flights: 'उड़ानें',
                trains: 'रेलगाड़ियां',
                buses: 'बसें',
                transfers: 'ट्रांसफर',
                hotels: 'होटल',
                activities: 'गतिविधियां',
                inclusions: 'समावेश',
                exclusions: 'बहिष्करण',
                totalCost: 'कुल अनुमानित लागत',
                about: 'ट्रैवलवर्स के बारे में',
                terms: 'नियम और शर्तें',
                downloadApp: 'हमारा ऑन-ट्रिप ऐप डाउनलोड करें',
                tripOverview: 'आपकी यात्रा का अवलोकन',
                tripQuote: 'यात्रा का कोटेशन',
                preparedFor: 'के लिए तैयार:',
                daywiseItinerary: 'दिन-वार यात्रा कार्यक्रम',
                day: 'दिन',
                page: 'पृष्ठ',
                of: 'का',
                craftedBy: 'द्वारा तैयार किया गया',
                whereEveryJourney: 'जहां हर यात्रा आपके मूड के अनुसार डिज़ाइन की जाती है।'
            },
            es: {
                title: 'Planificador de Itinerarios Travelverse',
                clientName: 'Nombre del Cliente',
                email: 'Correo Electrónico',
                travelDates: 'Fechas de Viaje',
                country: 'País',
                places: 'Lugares',
                nights: 'Noches',
                travelers: 'Viajeros',
                flights: 'Vuelos',
                trains: 'Trenes',
                buses: 'Autobuses',
                transfers: 'Traslados',
                hotels: 'Hoteles',
                activities: 'Actividades',
                inclusions: 'Inclusiones',
                exclusions: 'Exclusiones',
                totalCost: 'Costo Total Estimado',
                about: 'Acerca de Travelverse',
                terms: 'Términos y Condiciones',
                downloadApp: 'Descarga Nuestra App de Viaje',
                tripOverview: 'RESUMEN DE TU VIAJE',
                tripQuote: 'COTIZACIÓN DE VIAJE',
                preparedFor: 'Preparado para:',
                daywiseItinerary: 'Itinerario por Días',
                day: 'Día',
                page: 'Página',
                of: 'de',
                craftedBy: 'Creado por Travelverse para',
                whereEveryJourney: 'Donde cada viaje está diseñado alrededor de tu vibra.'
            },
            fr: {
                title: 'Planificateur d\'Itinéraires Travelverse',
                clientName: 'Nom du Client',
                email: 'Email',
                travelDates: 'Dates de Voyage',
                country: 'Pays',
                places: 'Lieux',
                nights: 'Nuits',
                travelers: 'Voyageurs',
                flights: 'Vols',
                trains: 'Trains',
                buses: 'Bus',
                transfers: 'Transferts',
                hotels: 'Hôtels',
                activities: 'Activités',
                inclusions: 'Inclusions',
                exclusions: 'Exclusions',
                totalCost: 'Coût Total Estimé',
                about: 'À Propos de Travelverse',
                terms: 'Termes et Conditions',
                downloadApp: 'Téléchargez Notre App de Voyage',
                tripOverview: 'APERÇU DE VOTRE VOYAGE',
                tripQuote: 'DEVIS DE VOYAGE',
                preparedFor: 'Préparé pour:',
                daywiseItinerary: 'Itinéraire par Jours',
                day: 'Jour',
                page: 'Page',
                of: 'sur',
                craftedBy: 'Créé par Travelverse pour',
                whereEveryJourney: 'Où chaque voyage est conçu autour de votre ambiance.'
            }
        };
        
        // Enhanced PDF Features - Theme Support
        const pdfThemes = {
            default: {
                primaryColor: '#05C3DE',
                secondaryColor: '#4ee0f0',
                backgroundColor: '#f5f5f7',
                textColor: '#1d1d1f',
                accentColor: '#333'
            },
            premium: {
                primaryColor: '#2C3E50',
                secondaryColor: '#E74C3C',
                backgroundColor: '#ECF0F1',
                textColor: '#2C3E50',
                accentColor: '#E74C3C'
            },
            minimal: {
                primaryColor: '#000000',
                secondaryColor: '#666666',
                backgroundColor: '#ffffff',
                textColor: '#000000',
                accentColor: '#333333'
            },
            corporate: {
                primaryColor: '#1F4E79',
                secondaryColor: '#4A90E2',
                backgroundColor: '#F8F9FA',
                textColor: '#1F4E79',
                accentColor: '#4A90E2'
            }
        };
        

        
        const predefinedInclusions = [ 'International Flight', 'Internal Flight', 'Private Airport Transfers', 'Accommodation with breakfast', 'Mentioned Sightseeings, transfers', 'Inter hotel Transfers', 'Visa', 'GST' ];
        const predefinedExclusions = [ 'TCS', 'Flights', 'Beverages, Lunch, Dinner throughout the tours', 'City tax at the Hotel if applicable', 'Any other services not specified above', 'Any Personal Expenses', 'Early check in/Late check out' ];

        function displayError(message) { errorDisplay.textContent = message; errorDisplay.classList.remove('hidden'); }
        function clearError() { if (!errorDisplay.classList.contains('hidden')) { errorDisplay.classList.add('hidden'); } }
        function calculateNights(start, end) { if (!start || !end) return 0; const startDate = new Date(start); const endDate = new Date(end); return (endDate > startDate) ? Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) : 0; }

        function saveData() {
            const data = {
                clientName: document.getElementById("clientName").value, clientEmail: document.getElementById("clientEmail").value,
                startDate: document.getElementById("startDate").value, endDate: document.getElementById("endDate").value,
                country: document.getElementById("country").value, adults: document.getElementById("adults").value,
                kids: document.getElementById("kids").value, places,
                marginCost: document.getElementById("marginCost").value,
                flights, trains, buses, transfers, hotels, activities, inclusions, exclusions,
                lastSaved: new Date().toISOString()
            };
            localStorage.setItem('travelItineraryData', JSON.stringify(data));
            showSaveNotification();
        }
        
        function showSaveNotification() {
            // Create or update save notification
            let notification = document.getElementById('saveNotification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'saveNotification';
                notification.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: var(--card-bg-color);
                    border: 1px solid var(--border-color);
                    border-radius: var(--radius-m);
                    padding: 12px 20px;
                    box-shadow: var(--shadow);
                    z-index: 1000;
                    font-size: 0.9rem;
                    color: var(--text-primary);
                    transform: translateY(100px);
                    opacity: 0;
                    transition: all 0.3s ease;
                `;
                document.body.appendChild(notification);
            }
            
            notification.textContent = '💾 Auto-saved successfully';
            notification.style.transform = 'translateY(0)';
            notification.style.opacity = '1';
            
            setTimeout(() => {
                notification.style.transform = 'translateY(100px)';
                notification.style.opacity = '0';
            }, 2000);
        }

        function loadData() {
            const savedData = localStorage.getItem('travelItineraryData');
            const data = savedData ? JSON.parse(savedData) : {};
            
            document.getElementById("clientName").value = data.clientName || '';
            document.getElementById("clientEmail").value = data.clientEmail || '';
            document.getElementById("startDate").value = data.startDate || '';
            document.getElementById("endDate").value = data.endDate || '';
            document.getElementById("country").value = data.country || '';
            document.getElementById("adults").value = data.adults || '1';
            document.getElementById("kids").value = data.kids || '0';
            document.getElementById("marginCost").value = data.marginCost || '';
            places = data.places || [];
            flights = data.flights || [];
            trains = data.trains || [];
            buses = data.buses || [];
            transfers = data.transfers || [];
            hotels = data.hotels || [];
            activities = data.activities || [];
            
            // Initialize inclusions and exclusions with predefined values if not already saved
            if (data.inclusions && data.inclusions.length > 0) {
                inclusions = data.inclusions;
            } else {
                inclusions = predefinedInclusions.map(text => ({ text, checked: true, custom: false }));
            }
            
            if (data.exclusions && data.exclusions.length > 0) {
                exclusions = data.exclusions;
            } else {
                exclusions = predefinedExclusions.map(text => ({ text, checked: true, custom: false }));
            }

            renderInclusionsExclusions();
            initializeDateLogic(); 
            updateKidsAges();
            renderPlaces();
            updateProgress();

            if (data.clientName) { generateItinerary(); }
        }
        
        function renderInclusionsExclusions() {
            const renderList = (type, listContainerId) => {
                const list = type === 'inclusion' ? inclusions : exclusions;
                const container = document.getElementById(listContainerId);
                container.innerHTML = '';
                list.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'checkbox-group';
                    const checkboxId = `${type}-${index}`;
                    div.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" onchange="toggleInclusionExclusion('${type}', ${index})" ${item.checked ? 'checked' : ''}>
                        <label for="${checkboxId}">${item.text}</label>
                        ${item.custom ? `<button class="btn-remove" style="padding: 2px 8px; font-size: 12px;" onclick="removeInclusionExclusion('${type}', ${index})">✖</button>` : ''}
                    `;
                    container.appendChild(div);
                });
            };
            renderList('inclusion', 'inclusionsList');
            renderList('exclusion', 'exclusionsList');
            saveData();
        }

        function toggleInclusionExclusion(type, index) { const list = type === 'inclusion' ? inclusions : exclusions; list[index].checked = !list[index].checked; saveData(); if(!document.getElementById('itinerary').classList.contains('hidden')) { generateItinerary(); } }
        function addInclusionExclusion(type) { const inputId = type === 'inclusion' ? 'customInclusion' : 'customExclusion'; const input = document.getElementById(inputId); const text = input.value.trim(); if (text) { const list = type === 'inclusion' ? inclusions : exclusions; list.push({ text, checked: true, custom: true }); input.value = ''; renderInclusionsExclusions(); } }
        function removeInclusionExclusion(type, index) { const list = type === 'inclusion' ? inclusions : exclusions; list.splice(index, 1); renderInclusionsExclusions(); }
        
        function resetInclusionsExclusions() {
            inclusions = predefinedInclusions.map(text => ({ text, checked: true, custom: false }));
            exclusions = predefinedExclusions.map(text => ({ text, checked: true, custom: false }));
            renderInclusionsExclusions();
            showNotification('Inclusions and exclusions reset to default values', 'success');
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.toggle('collapsed');
                const icon = section.querySelector('.toggle-icon');
                if (icon) {
                    icon.textContent = section.classList.contains('collapsed') ? '▶' : '▼';
                }
            }
        }

        function makeAllSectionsCollapsible() {
            const sections = [
                { id: 'trainDetailsCard', title: '🚆 Train Details' },
                { id: 'busDetailsCard', title: '🚌 Bus Details' },
                { id: 'transfersCard', title: '🚗 Airport/Train Station Transfers' },
                { id: 'hotelCard', title: '🏨 Hotel Accommodations' },
                { id: 'activitiesCard', title: '🏞️ Activities & Tours' },
                { id: 'weatherCard', title: '🌤️ Weather & Travel Info' },
                { id: 'costingCard', title: '💰 Costing & Margin' },
                { id: 'inclusionsCard', title: '📦 Inclusions & Exclusions' },
                { id: 'timezoneCard', title: '⏰ Time Zone Calculator' },
                { id: 'visaCard', title: '🛂 Visa & Travel Requirements' },
                { id: 'packingCard', title: '🧳 Smart Packing List Generator' },
                { id: 'templatesCard', title: '📋 Templates & Export' }
            ];

            sections.forEach(section => {
                const existingCard = document.querySelector(`h2:contains('${section.title.split(' ').slice(1).join(' ')}')`).closest('.card');
                if (existingCard && !existingCard.classList.contains('collapsible')) {
                    existingCard.id = section.id;
                    existingCard.classList.add('collapsible');
                    
                    const h2 = existingCard.querySelector('h2');
                    const content = existingCard.innerHTML;
                    
                    existingCard.innerHTML = `
                        <div class="card-header" onclick="toggleSection('${section.id}')">
                            <h2>${section.title}</h2>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="card-content">
                            ${content.replace(`<h2>${section.title}</h2>`, '')}
                        </div>
                    `;
                }
            });
        }

        // --- NEW MASTER DATE LOGIC ---
        function initializeDateLogic() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const checkInInput = document.getElementById('checkIn');
            const checkOutInput = document.getElementById('checkOut');

            const allEventDateInputs = document.querySelectorAll('#flightDate, #trainDate, #busDate, #activityDate, #checkIn');

            if (startDateInput.value) {
                endDateInput.min = startDateInput.value;
            }
            if (endDateInput.value) {
                startDateInput.max = endDateInput.value;
            }

            allEventDateInputs.forEach(input => {
                if (startDateInput.value) input.min = startDateInput.value;
                else input.removeAttribute('min');
                
                if (endDateInput.value) input.max = endDateInput.value;
                else input.removeAttribute('max');
            });
            
            if (checkInInput.value) {
                checkOutInput.disabled = false;
                checkOutInput.min = checkInInput.value;
                if (endDateInput.value) {
                    checkOutInput.max = endDateInput.value;
                } else {
                    checkOutInput.removeAttribute('max');
                }
                if (checkOutInput.value && new Date(checkOutInput.value) < new Date(checkInInput.value)) {
                    checkOutInput.value = '';
                }
            } else {
                checkOutInput.disabled = true;
                checkOutInput.value = '';
            }
            
            document.getElementById("nightsDisplay").innerText = calculateNights(startDateInput.value, endDateInput.value);
            saveData();
        }

        document.getElementById('startDate').addEventListener('change', initializeDateLogic);
        document.getElementById('endDate').addEventListener('change', initializeDateLogic);
        document.getElementById('checkIn').addEventListener('change', initializeDateLogic);
        // --- END OF NEW DATE LOGIC ---


        function updateKidsAges() { const kidsCount = parseInt(document.getElementById("kids").value) || 0; const container = document.getElementById("kidsAgesContainer"); container.innerHTML = ''; for (let i = 1; i <= kidsCount; i++) { const formGroup = document.createElement("div"); formGroup.className = "form-group"; formGroup.innerHTML = `<label for="kidAge${i}">Age of Kid ${i}</label><input type="number" id="kidAge${i}" placeholder="e.g., 5" min="0" max="17">`; container.appendChild(formGroup); } }
        function addPlace() { clearError(); const placeInput = document.getElementById("place"); const place = placeInput.value.trim(); if (!place) return displayError("Please enter a valid place name."); if (places.includes(place)) return displayError("This place has already been added."); places.push(place); renderPlaces(); placeInput.value = ''; saveData(); }
        function removePlace(index) { places.splice(index, 1); renderPlaces(); saveData(); if (!document.getElementById("itinerary").classList.contains('hidden')) generateItinerary(); }
        function renderPlaces() { document.getElementById("placesList").innerHTML = places.map((p, i) => `<span style="display:inline-flex; align-items:center; gap: 8px; background: #eef1f4; padding: 5px 10px; border-radius: 6px; margin-right: 10px; margin-bottom: 10px;">${p} <button class="btn-remove" style="padding: 2px 6px; font-size:12px;" onclick="removePlace(${i})">✖</button></span>`).join(''); }
        function clearFormFields(fields) { fields.forEach(id => document.getElementById(id).value = ''); }
        
        // --- FLIGHT LOGIC ---
        function resetFlightForm() {
            currentlyEditing = null;
            clearFormFields(["airline", "departure", "arrival", "flightDate", "flightCost", "flightDescription"]);
            document.getElementById('flightActions').innerHTML = `<button class="btn-secondary" onclick="addFlight()">+ Add Flight</button>`;
        }
        function addFlight() {
            const data = { airline: document.getElementById("airline").value.trim(), departure: document.getElementById("departure").value.trim(), arrival: document.getElementById("arrival").value.trim(), flightDate: document.getElementById("flightDate").value, flightCost: parseFloat(document.getElementById("flightCost").value) || 0, flightDescription: document.getElementById("flightDescription").value.trim() };
            if (!data.airline || !data.departure || !data.arrival || !data.flightDate) { return displayError("Please fill all required flight details."); }
            flights.push(data);
            saveData();
            if(!document.getElementById('itinerary').classList.contains('hidden')) generateItinerary();
            resetFlightForm();
        }
        function editFlight(index) {
            currentlyEditing = { type: 'flight', index };
            const flight = flights[index];
            document.getElementById("airline").value = flight.airline;
            document.getElementById("departure").value = flight.departure;
            document.getElementById("arrival").value = flight.arrival;
            document.getElementById("flightDate").value = flight.flightDate;
            document.getElementById("flightCost").value = flight.flightCost;
            document.getElementById("flightDescription").value = flight.flightDescription;
            document.getElementById('flightActions').innerHTML = `
                <button class="btn-primary" onclick="updateFlight()">Update Flight</button>
                <button class="btn-secondary" onclick="resetFlightForm()">Cancel</button>`;
            document.getElementById('airline').focus();
        }
        function updateFlight() {
            const index = currentlyEditing.index;
            const data = { airline: document.getElementById("airline").value.trim(), departure: document.getElementById("departure").value.trim(), arrival: document.getElementById("arrival").value.trim(), flightDate: document.getElementById("flightDate").value, flightCost: parseFloat(document.getElementById("flightCost").value) || 0, flightDescription: document.getElementById("flightDescription").value.trim() };
            if (!data.airline || !data.departure || !data.arrival || !data.flightDate) { return displayError("Please fill all required flight details."); }
            flights[index] = data;
            saveData();
            generateItinerary();
            resetFlightForm();
        }
        function removeFlight(index) { flights.splice(index, 1); saveData(); generateItinerary(); }
        
        // --- TRAIN LOGIC ---
        function resetTrainForm() {
            currentlyEditing = null;
            clearFormFields(["trainName", "trainDate", "trainTime", "trainDescription", "trainCost"]);
            document.getElementById('trainActions').innerHTML = `<button class="btn-secondary" onclick="addTrain()">+ Add Train</button>`;
        }
        function addTrain() {
            const data = { name: document.getElementById("trainName").value.trim(), date: document.getElementById("trainDate").value, time: document.getElementById("trainTime").value, description: document.getElementById("trainDescription").value.trim(), trainCost: parseFloat(document.getElementById("trainCost").value) || 0 };
            if (!data.name || !data.date) { return displayError("Please fill Train Name and Date."); }
            trains.push(data);
            saveData();
            if(!document.getElementById("itinerary").classList.contains('hidden')) generateItinerary();
            resetTrainForm();
        }
        function editTrain(index) {
            currentlyEditing = { type: 'train', index };
            const train = trains[index];
            document.getElementById("trainName").value = train.name;
            document.getElementById("trainDate").value = train.date;
            document.getElementById("trainTime").value = train.time;
            document.getElementById("trainDescription").value = train.description;
            document.getElementById("trainCost").value = train.trainCost;
            document.getElementById('trainActions').innerHTML = `
                <button class="btn-primary" onclick="updateTrain()">Update Train</button>
                <button class="btn-secondary" onclick="resetTrainForm()">Cancel</button>`;
            document.getElementById('trainName').focus();
        }
        function updateTrain() {
            const index = currentlyEditing.index;
            const data = { name: document.getElementById("trainName").value.trim(), date: document.getElementById("trainDate").value, time: document.getElementById("trainTime").value, description: document.getElementById("trainDescription").value.trim(), trainCost: parseFloat(document.getElementById("trainCost").value) || 0 };
            if (!data.name || !data.date) { return displayError("Please fill Train Name and Date."); }
            trains[index] = data;
            saveData();
            generateItinerary();
            resetTrainForm();
        }
        function removeTrain(index) { trains.splice(index, 1); saveData(); generateItinerary(); }

        // --- BUS LOGIC ---
        function resetBusForm() {
            currentlyEditing = null;
            clearFormFields(["busName", "busDate", "busDescription", "busCost"]);
            document.getElementById('busActions').innerHTML = `<button class="btn-secondary" onclick="addBus()">+ Add Bus</button>`;
        }
        function addBus() {
            const data = { name: document.getElementById("busName").value.trim(), date: document.getElementById("busDate").value, description: document.getElementById("busDescription").value.trim(), busCost: parseFloat(document.getElementById("busCost").value) || 0 };
            if (!data.name || !data.date) { return displayError("Please fill Bus Name and Date."); }
            buses.push(data);
            saveData();
            if(!document.getElementById("itinerary").classList.contains('hidden')) generateItinerary();
            resetBusForm();
        }
        function editBus(index) {
            currentlyEditing = { type: 'bus', index };
            const bus = buses[index];
            document.getElementById("busName").value = bus.name;
            document.getElementById("busDate").value = bus.date;
            document.getElementById("busDescription").value = bus.description;
            document.getElementById("busCost").value = bus.busCost;
            document.getElementById('busActions').innerHTML = `
                <button class="btn-primary" onclick="updateBus()">Update Bus</button>
                <button class="btn-secondary" onclick="resetBusForm()">Cancel</button>`;
            document.getElementById('busName').focus();
        }
        function updateBus() {
            const index = currentlyEditing.index;
            const data = { name: document.getElementById("busName").value.trim(), date: document.getElementById("busDate").value, description: document.getElementById("busDescription").value.trim(), busCost: parseFloat(document.getElementById("busCost").value) || 0 };
            if (!data.name || !data.date) { return displayError("Please fill Bus Name and Date."); }
            buses[index] = data;
            saveData();
            generateItinerary();
            resetBusForm();
        }
        function removeBus(index) { buses.splice(index, 1); saveData(); generateItinerary(); }
        
         // --- TRANSFER LOGIC ---
        function resetTransferForm() {
            currentlyEditing = null;
            clearFormFields(["transferName", "transferType", "transferCost"]);
            document.getElementById('transferActions').innerHTML = `<button class="btn-secondary" onclick="addTransfer()">+ Add Transfer</button>`;
        }
        function addTransfer() {
            const data = { name: document.getElementById("transferName").value.trim(), type: document.getElementById("transferType").value, cost: parseFloat(document.getElementById("transferCost").value) || 0 };
            if (!data.name || !data.type) { return displayError("Please fill Transfer Name and Type."); }
            transfers.push(data);
            saveData();
            if(!document.getElementById("itinerary").classList.contains('hidden')) generateItinerary();
            resetTransferForm();
        }
        function editTransfer(index) {
            currentlyEditing = { type: 'transfer', index };
            const transfer = transfers[index];
            document.getElementById("transferName").value = transfer.name;
            document.getElementById("transferType").value = transfer.type;
            document.getElementById("transferCost").value = transfer.cost;
            document.getElementById('transferActions').innerHTML = `
                <button class="btn-primary" onclick="updateTransfer()">Update Transfer</button>
                <button class="btn-secondary" onclick="resetTransferForm()">Cancel</button>`;
            document.getElementById('transferName').focus();
        }
        function updateTransfer() {
            const index = currentlyEditing.index;
            const data = { name: document.getElementById("transferName").value.trim(), type: document.getElementById("transferType").value, cost: parseFloat(document.getElementById("transferCost").value) || 0 };
            if (!data.name || !data.type) { return displayError("Please fill Transfer Name and Type."); }
            transfers[index] = data;
            saveData();
            generateItinerary();
            resetTransferForm();
        }
        function removeTransfer(index) { transfers.splice(index, 1); saveData(); generateItinerary(); }


        // --- HOTEL LOGIC ---
        function resetHotelForm() {
            currentlyEditing = null;
            clearFormFields(["hotelName", "hotelLocation", "roomCategory", "checkIn", "checkOut", "hotelCost"]);
            initializeDateLogic(); // Reset date states
            document.getElementById('hotelActions').innerHTML = `<button class="btn-secondary" onclick="addHotel()">+ Add Hotel</button>`;
        }
        function addHotel() {
            const data = { hotelName: document.getElementById("hotelName").value.trim(), hotelLocation: document.getElementById("hotelLocation").value.trim(), roomCategory: document.getElementById("roomCategory").value.trim(), checkIn: document.getElementById("checkIn").value, checkOut: document.getElementById("checkOut").value, hotelCost: parseFloat(document.getElementById("hotelCost").value) || 0 };
            if (!data.hotelName || !data.hotelLocation || !data.checkIn || !data.checkOut) { return displayError("Please fill all required hotel details."); }
            if (new Date(data.checkOut) < new Date(data.checkIn)) { return displayError("Check-out date must be on or after the check-in date."); }
            hotels.push(data);
            saveData();
            if(!document.getElementById('itinerary').classList.contains('hidden')) generateItinerary();
            resetHotelForm();
        }
        function editHotel(index) {
            currentlyEditing = { type: 'hotel', index };
            const hotel = hotels[index];
            document.getElementById("hotelName").value = hotel.hotelName;
            document.getElementById("hotelLocation").value = hotel.hotelLocation;
            document.getElementById("roomCategory").value = hotel.roomCategory;
            document.getElementById("checkIn").value = hotel.checkIn;
            document.getElementById("checkOut").value = hotel.checkOut;
            document.getElementById("hotelCost").value = hotel.hotelCost;
            initializeDateLogic(); 
            document.getElementById('hotelActions').innerHTML = `
                <button class="btn-primary" onclick="updateHotel()">Update Hotel</button>
                <button class="btn-secondary" onclick="resetHotelForm()">Cancel</button>`;
            document.getElementById('hotelName').focus();
        }
        function updateHotel() {
            const index = currentlyEditing.index;
            const data = { hotelName: document.getElementById("hotelName").value.trim(), hotelLocation: document.getElementById("hotelLocation").value.trim(), roomCategory: document.getElementById("roomCategory").value.trim(), checkIn: document.getElementById("checkIn").value, checkOut: document.getElementById("checkOut").value, hotelCost: parseFloat(document.getElementById("hotelCost").value) || 0 };
            if (!data.hotelName || !data.hotelLocation || !data.checkIn || !data.checkOut) { return displayError("Please fill all required hotel details."); }
            if (new Date(data.checkOut) < new Date(data.checkIn)) { return displayError("Check-out date must be on or after the check-in date."); }
            hotels[index] = data;
            saveData();
            generateItinerary();
            resetHotelForm();
        }
        function removeHotel(index) { hotels.splice(index, 1); saveData(); generateItinerary(); }
        
        // --- ACTIVITY LOGIC ---
        function resetActivityForm() {
            currentlyEditing = null;
            clearFormFields(["activityName", "activityLocation", "activityDate", "activityCost", "activityDescription"]);
            document.getElementById('activityActions').innerHTML = `<button class="btn-secondary" onclick="addActivity()">+ Add Activity</button>`;
        }
        function addActivity() {
            const data = { activityName: document.getElementById("activityName").value.trim(), activityLocation: document.getElementById("activityLocation").value.trim(), activityDate: document.getElementById("activityDate").value, activityCost: parseFloat(document.getElementById("activityCost").value) || 0, activityDescription: document.getElementById("activityDescription").value.trim() };
            if (!data.activityName || !data.activityLocation || !data.activityDate) { return displayError("Please fill at least the Activity Name, Location, and Date."); }
            activities.push(data);
            saveData();
            if(!document.getElementById('itinerary').classList.contains('hidden')) generateItinerary();
            resetActivityForm();
        }
        function editActivity(index) {
            currentlyEditing = { type: 'activity', index };
            const activity = activities[index];
            document.getElementById("activityName").value = activity.activityName;
            document.getElementById("activityLocation").value = activity.activityLocation;
            document.getElementById("activityDate").value = activity.activityDate;
            document.getElementById("activityCost").value = activity.activityCost;
            document.getElementById("activityDescription").value = activity.activityDescription;
            document.getElementById('activityActions').innerHTML = `
                <button class="btn-primary" onclick="updateActivity()">Update Activity</button>
                <button class="btn-secondary" onclick="resetActivityForm()">Cancel</button>`;
            document.getElementById('activityName').focus();
        }
        function updateActivity() {
            const index = currentlyEditing.index;
            const data = { activityName: document.getElementById("activityName").value.trim(), activityLocation: document.getElementById("activityLocation").value.trim(), activityDate: document.getElementById("activityDate").value, activityCost: parseFloat(document.getElementById("activityCost").value) || 0, activityDescription: document.getElementById("activityDescription").value.trim() };
            if (!data.activityName || !data.activityLocation || !data.activityDate) { return displayError("Please fill at least the Activity Name, Location, and Date."); }
            activities[index] = data;
            saveData();
            generateItinerary();
            resetActivityForm();
        }
        function removeActivity(index) { activities.splice(index, 1); saveData(); generateItinerary(); }


        function generateItinerary(shouldScroll = false) {
            clearError();
            const clientName = document.getElementById("clientName").value.trim();
            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;
            if (!clientName || !startDate || !endDate) { if(document.getElementById('itinerary').classList.contains('hidden')) {return} else { displayError("Please fill in Traveler Name and Travel Dates.")}; return; }
            document.getElementById("itinerary").classList.remove("hidden");
            
            document.getElementById("itineraryClientName").innerText = clientName;
            document.getElementById("itineraryClientEmail").innerText = document.getElementById("clientEmail").value || 'N/A';
            document.getElementById("itineraryTravelDates").innerText = `${startDate} to ${endDate}`;
            document.getElementById("itineraryCountry").innerText = document.getElementById("country").value || 'N/A';
            document.getElementById("itineraryPlaces").innerText = places.join(", ") || "N/A";
            document.getElementById("itineraryNights").innerText = calculateNights(startDate, endDate);
            document.getElementById("itineraryTravelers").innerText = `${document.getElementById("adults").value} Adults, ${document.getElementById("kids").value} Kids`;
            
            renderTables();
            renderAutomatedDayWise(startDate, endDate);
            
            const checkedInclusions = inclusions.filter(i => i.checked).map(i => `<li>${i.text}</li>`).join('');
            const checkedExclusions = exclusions.filter(e => e.checked).map(e => `<li>${e.text}</li>`).join('');
            document.getElementById("inclusionsListHtml").innerHTML = checkedInclusions;
            document.getElementById("exclusionsListHtml").innerHTML = checkedExclusions;
            if(checkedInclusions || checkedExclusions) { document.getElementById("inc_exc_section_html").classList.remove('hidden'); } else { document.getElementById("inc_exc_section_html").classList.add('hidden'); }

            const totalFlightCost = flights.reduce((sum, f) => sum + (f.flightCost || 0), 0);
            const totalTrainCost = trains.reduce((sum, t) => sum + (t.trainCost || 0), 0);
            const totalBusCost = buses.reduce((sum, b) => sum + (b.busCost || 0), 0);
            const totalTransferCost = transfers.reduce((sum, t) => sum + (t.cost || 0), 0);
            const totalHotelCost = hotels.reduce((sum, h) => sum + (h.hotelCost || 0), 0);
            const totalActivityCost = activities.reduce((sum, a) => sum + (a.activityCost || 0), 0);
            const marginCost = parseFloat(document.getElementById("marginCost").value) || 0;

            document.getElementById("totalCost").innerText = (totalFlightCost + totalTrainCost + totalBusCost + totalTransferCost + totalHotelCost + totalActivityCost + marginCost).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            makeTablesSortable();

            if (shouldScroll) {
                document.getElementById("itinerary").scrollIntoView({ behavior: 'smooth' });
            }
        }

        function renderTables() {
            const render = (tableId, sectionId, data, columns, editFn, removeFn) => {
                const tableBody = document.getElementById(tableId).querySelector("tbody");
                const section = document.getElementById(sectionId);
                tableBody.innerHTML = '';
                if (data.length === 0) { section.style.display = 'none'; return; }
                section.style.display = 'block';
                data.forEach((item, index) => {
                    const row = tableBody.insertRow();
                    columns.forEach(col => row.insertCell().textContent = col.render(item));
                    const actionCell = row.insertCell();
                    actionCell.className = 'actions-cell';
                    actionCell.innerHTML = `
                        <button class="btn-edit" onclick="${editFn}(${index})">Edit</button>
                        <button class="btn-remove" onclick="${removeFn}(${index})">Remove</button>`;
                });
            };
            const formatCurrency = (num) => `₹${(num || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            render('flightsTable', 'flights_section', flights, [{ render: i => i.airline }, { render: i => i.departure }, { render: i => i.arrival }, { render: i => i.flightDate }, { render: i => formatCurrency(i.flightCost) }], 'editFlight', 'removeFlight');
            render('trainsTable', 'trains_section', trains, [{ render: i => i.name }, { render: i => i.date }, { render: i => i.time || 'N/A' }, { render: i => i.description }, { render: i => formatCurrency(i.trainCost) }], 'editTrain', 'removeTrain');
            render('busesTable', 'buses_section', buses, [{ render: i => i.name }, { render: i => i.date }, { render: i => i.description }, { render: i => formatCurrency(i.busCost) }], 'editBus', 'removeBus');
            render('transfersTable', 'transfers_section', transfers, [{ render: i => i.name }, { render: i => i.type }, { render: i => formatCurrency(i.cost) }], 'editTransfer', 'removeTransfer');
            render('hotelsTable', 'hotels_section', hotels, [{ render: i => i.hotelName }, { render: i => i.hotelLocation }, { render: i => i.roomCategory }, { render: i => i.checkIn }, { render: i => i.checkOut }, { render: i => formatCurrency(i.hotelCost) }], 'editHotel', 'removeHotel');
            render('activitiesTable', 'activities_section', activities, [{ render: i => i.activityName }, { render: i => i.activityDescription }, { render: i => i.activityDate }, { render: i => formatCurrency(i.activityCost) }], 'editActivity', 'removeActivity');
        }

        function makeTablesSortable() {
            const sortableOptions = (dataArray) => ({
                animation: 150,
                onEnd: (evt) => {
                    const [item] = dataArray.splice(evt.oldIndex, 1);
                    dataArray.splice(evt.newIndex, 0, item);
                    saveData();
                    generateItinerary();
                }
            });
            if (typeof Sortable === 'undefined') return;
            new Sortable(document.getElementById('flightsTable').querySelector('tbody'), sortableOptions(flights));
            new Sortable(document.getElementById('trainsTable').querySelector('tbody'), sortableOptions(trains));
            new Sortable(document.getElementById('busesTable').querySelector('tbody'), sortableOptions(buses));
            new Sortable(document.getElementById('transfersTable').querySelector('tbody'), sortableOptions(transfers));
            new Sortable(document.getElementById('hotelsTable').querySelector('tbody'), sortableOptions(hotels));
            new Sortable(document.getElementById('activitiesTable').querySelector('tbody'), sortableOptions(activities));
        }


        function renderAutomatedDayWise(startDateStr, endDateStr) {
            const container = document.getElementById("dayWiseItinerary");
            const section = document.getElementById("daywise_section");
            container.innerHTML = '';
            const totalNights = calculateNights(startDateStr, endDateStr);
            if (totalNights < 0) { section.style.display = 'none'; return; }
            const totalDays = totalNights + 1;
            let hasContent = false;
            const startDate = new Date(startDateStr);
            for (let i = 0; i < totalDays; i++) {
                const currentDate = new Date(startDate);
                currentDate.setUTCDate(currentDate.getUTCDate() + i);
                const dateString = currentDate.toISOString().split('T')[0];
                
                let eventsHtml = '';

                hotels.filter(h => h.checkOut === dateString).forEach(h => { eventsHtml += `<li><div class="item-details"><span class="item-title">🏨 Check-out: ${h.hotelName}</span><span class="item-location">${h.hotelLocation}</span></div></li>`; });
                flights.filter(f => f.flightDate === dateString).forEach(f => { eventsHtml += `<li><div class="item-details"><span class="item-title">✈️ Flight: ${f.airline} to ${f.arrival}</span><span class="item-location">${f.flightDescription || 'Details unavailable'}</span></div></li>`; });
                trains.filter(t => t.date === dateString).forEach(t => { eventsHtml += `<li><div class="item-details"><span class="item-title">🚆 Train: ${t.name}</span><span class="item-location">${t.description || 'Details unavailable'}</span></div></li>`; });
                buses.filter(b => b.date === dateString).forEach(b => { eventsHtml += `<li><div class="item-details"><span class="item-title">🚌 Bus: ${b.name}</span><span class="item-location">${b.description || 'Details unavailable'}</span></div></li>`; });
                hotels.filter(h => h.checkIn === dateString).forEach(h => { eventsHtml += `<li><div class="item-details"><span class="item-title">🏨 Check-in: ${h.hotelName}</span><span class="item-location">${h.hotelLocation}</span></div></li>`; });
                activities.filter(a => a.activityDate === dateString).forEach(a => { eventsHtml += `<li><div class="item-details"><span class="item-title">🏞️ Activity: ${a.activityName}</span><span class="item-location">${a.activityLocation}</span></div></li>`; });

                if (eventsHtml) {
                    hasContent = true;
                    const dayHeader = `<h4>${currentDate.toLocaleDateString('en-US', { timeZone: 'UTC', weekday: 'long', month: 'long', day: 'numeric' })}</h4>`;
                    container.innerHTML += `<div class="day-entry" data-day="${i + 1}">${dayHeader}<ul class="day-item-list">${eventsHtml}</ul></div>`;
                }
            }
            section.style.display = hasContent ? 'block' : 'none';
        }

        function formatDateToDDMMYYYY(dateStr) {
            if (!dateStr || !dateStr.includes('-')) return dateStr;
            const [year, month, day] = dateStr.split('-');
            return `${day}-${month}-${year}`;
        }
        
        async function downloadPDF(pdfType) {
            clearError();
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                alert("PDF libraries not loaded. Please check your internet connection.");
                return;
            }
            if (!document.getElementById('clientName').value) {
                displayError("Cannot generate a PDF without a client name.");
                return;
            }

            try {
                // Get PDF options
                const language = document.getElementById('pdfLanguage').value || 'en';
                const theme = document.getElementById('pdfTheme').value || 'default';
                const customColors = document.getElementById('customColors').value;
                
                // Get translations
                const t = translations[language] || translations.en;
                
                // Get theme colors
                let themeColors = pdfThemes[theme];
                if (customColors) {
                    const [primary, secondary] = customColors.split(',');
                    themeColors = {
                        ...themeColors,
                        primaryColor: primary?.trim() || themeColors.primaryColor,
                        secondaryColor: secondary?.trim() || themeColors.secondaryColor
                    };
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
                
                const brandColor = themeColors.primaryColor;
                const textColor = themeColors.textColor;
                const lightTextColor = '#515154';
                const borderColor = '#dee2e6';
                const backgroundColor = themeColors.backgroundColor;
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 40;
                const usableWidth = pageWidth - (margin * 2);

                const sanitizeText = (text) => {
                    if (typeof text !== 'string' || !text) return '';
                    return text
                        .replace(/[`'']/g, "")      
                        .replace(/\s\s+/g, ' ')         
                        .replace(/[^\x20-\x7E]/g, '')   
                        .trim();
                };
                
                const formatCurrencyForPDF = (num) => `INR ${ (num || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                doc.setFont('Helvetica');
                let yPos = 0;

                // --- Header ---
                doc.setFillColor(brandColor);
                doc.rect(0, 0, pageWidth, 112, 'F');
                doc.setFontSize(22).setFont('Helvetica', 'bold').setTextColor('#FFFFFF').text('Travelverse.in', margin, 40);
                
                doc.setFontSize(8).setFont('Helvetica', 'normal').setTextColor('#FFFFFF');
                doc.text('We Work, DLF Forum, CyberCity, Phase 3, Gurugram, Haryana 122002', margin, 58);
                doc.text('Email : explore@travelverse.in', margin, 70);
                doc.text('Phone : +919996968070', margin, 82);
                doc.text('Awarded for excellence by Govt. of India (Ministry of Statistical Organisation by Shree PR Meshram)', margin, 94);
                doc.setFontSize(10).setTextColor('#FFFFFF').text('www.travelverse.in', pageWidth - margin, 40, { align: 'right' });

                yPos = 140;
                
                const addSectionHeader = (title, underline = true) => {
                    checkPageBreak(60);
                    yPos += 35; 
                    doc.setFontSize(14).setFont('Helvetica', 'bold').setTextColor(textColor).text(title, margin, yPos);
                    if (underline) {
                        const textWidth = doc.getTextWidth(title);
                        doc.setDrawColor(borderColor); 
                        doc.setLineWidth(1.5);
                        doc.line(margin, yPos + 4, margin + textWidth, yPos + 4);
                    }
                    yPos += 25; 
                };

                const addBulletedList = (items) => {
                    doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(lightTextColor);
                    items.forEach(item => {
                        const itemLines = doc.splitTextToSize(`•  ${sanitizeText(item)}`, usableWidth - 10);
                        checkPageBreak((itemLines.length * 11) + 3);
                        doc.text(itemLines, margin + 10, yPos);
                        yPos += (itemLines.length * 11) + 3;
                    });
                };
                
                const checkPageBreak = (requiredHeight) => {
                    if (yPos + requiredHeight > pageHeight - margin) {
                        doc.addPage();
                        yPos = margin;
                        return true;
                    }
                    return false;
                };
                
                function drawBarcode(doc, x, y, width, height) {
                    const numBars = Math.floor(width / 1.5);
                    let currentX = x;
                    doc.setFillColor(textColor);
                    for (let i = 0; i < numBars; i++) {
                        const barWidth = Math.random() * 1.2 + 0.4;
                        if (currentX + barWidth > x + width) break;
                        doc.rect(currentX, y, barWidth, height, 'F');
                        currentX += barWidth + (Math.random() * 0.8 + 0.4);
                    }
                }

                function drawPlaneIcon(doc, x, y, size, color) {
                    doc.setDrawColor(color);
                    doc.setLineWidth(1.5);
                    doc.line(x, y, x + size, y);
                    doc.line(x + size * 0.4, y, x + size * 0.6, y - size * 0.4);
                    doc.line(x + size * 0.4, y, x + size * 0.6, y + size * 0.4);
                    doc.line(x + size * 0.8, y, x + size * 0.9, y - size * 0.25);
                }

                const clientName = sanitizeText(document.getElementById('clientName').value);
                const countryName = sanitizeText(document.getElementById('country').value) || 'Your Destination';
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const nights = calculateNights(startDate, endDate);
                const travelers = `${document.getElementById("adults").value} Adults, ${document.getElementById("kids").value} Kids`;
                const placesJoined = sanitizeText(places.join(", ")) || 'N/A';

                const cardX = margin;
                const cardY = yPos;
                const cardWidth = usableWidth;
                const cardHeight = 175;
                const cornerRadius = 20;
                const stubWidth = 160;
                const mainWidth = cardWidth - stubWidth;
                const separatorX = cardX + mainWidth;

                // Enhanced card (Simplified)
                // Shadow effect
                doc.setFillColor('#E0E0E0');
                doc.roundedRect(cardX + 2, cardY + 2, cardWidth, cardHeight, cornerRadius, cornerRadius, 'F');
                
                // Main card
                doc.setFillColor('#FFFFFF');
                doc.roundedRect(cardX, cardY, cardWidth, cardHeight, cornerRadius, cornerRadius, 'F');
                
                // Card border
                doc.setDrawColor(brandColor);
                doc.setLineWidth(2);
                doc.roundedRect(cardX, cardY, cardWidth, cardHeight, cornerRadius, cornerRadius, 'S');

                let contentX = cardX + 25;
                let contentY = cardY + 30;
                const col2X = contentX + 180; 

                doc.setFontSize(10).setFont('Helvetica', 'bold').setTextColor(brandColor).text("YOUR TRIP OVERVIEW", contentX, contentY);
                doc.setFontSize(22).setFont('Helvetica', 'bold').setTextColor(textColor).text(countryName, contentX, contentY + 25);
                doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(lightTextColor).text("CLIENT", contentX, contentY + 55);
                doc.setFontSize(12).setFont('Helvetica', 'bold').setTextColor(textColor).text(clientName, contentX, contentY + 70);
                doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(lightTextColor).text("DATES", col2X, contentY + 55);
                doc.setFontSize(12).setFont('Helvetica', 'bold').setTextColor(textColor).text(`${formatDateToDDMMYYYY(startDate)} to ${formatDateToDDMMYYYY(endDate)}`, col2X, contentY + 70);
                doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(lightTextColor).text("PLACES TO VISIT", contentX, contentY + 95);
                doc.setFontSize(10).setFont('Helvetica', 'bold').setTextColor(textColor);
                const placesLines = doc.splitTextToSize(placesJoined, col2X - contentX - 15);
                doc.text(placesLines, contentX, contentY + 108);
                doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(lightTextColor).text("TRAVELERS", col2X, contentY + 95);
                doc.setFontSize(12).setFont('Helvetica', 'bold').setTextColor(textColor).text(travelers, col2X, contentY + 108);
                doc.setLineDashPattern([2, 2], 0);
                doc.setDrawColor(borderColor).line(separatorX, cardY + 15, separatorX, cardY + cardHeight - 15);
                doc.setLineDashPattern([], 0);
                
                const stubCenterX = separatorX + stubWidth / 2;
                drawPlaneIcon(doc, stubCenterX - 15, cardY + 25, 30, brandColor);
                doc.setFontSize(10).setFont('Helvetica', 'bold').setTextColor(textColor).text(t.tripQuote, stubCenterX, cardY + 55, { align: 'center' });
                doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(lightTextColor).text(t.preparedFor, stubCenterX, cardY + 75, { align: 'center' });
                doc.setFontSize(11).setFont('Helvetica', 'bold').setTextColor(textColor).text(clientName, stubCenterX, cardY + 90, { align: 'center' });
                
                // Simple barcode (removed QR code complexity)
                const barcodeY = cardY + 110;
                const barcodeWidth = stubWidth - 30;
                const barcodeHeight = 35;
                drawBarcode(doc, stubCenterX - (barcodeWidth / 2), barcodeY, barcodeWidth, barcodeHeight);
                doc.setFont('Helvetica', 'normal').setFontSize(7).setTextColor(lightTextColor).text("0123456789-TRVL-9876543210", stubCenterX, barcodeY + barcodeHeight + 7, { align: 'center'});
                yPos = cardY + cardHeight;
                
                const tableConfig = {
                    theme: 'plain',
                    styles: {
                        font: 'Helvetica',
                        fontSize: 9,
                        cellPadding: 10,
                        textColor: textColor,
                        lineColor: '#E0E0E0',
                        lineWidth: 0.3
                    },
                    headStyles: {
                        fillColor: brandColor,
                        textColor: '#ffffff',
                        fontStyle: 'bold',
                        fontSize: 11,
                        cellPadding: 12
                    },
                    alternateRowStyles: {
                        fillColor: '#F8F9FA'
                    },
                    startY: yPos,
                    didDrawPage: (data) => {
                        yPos = data.cursor.y;
                    },
                    didDrawTable: (data) => {
                        // Add rounded corners to tables
                        const { table } = data;
                        const { x, y, width, height } = table;
                        const cornerRadius = 8;
                        
                        // Draw rounded border around the entire table
                        doc.setDrawColor(brandColor);
                        doc.setLineWidth(1.5);
                        doc.roundedRect(x, y, width, height, cornerRadius, cornerRadius, 'S');
                        
                        // Add subtle shadow effect
                        doc.setFillColor('#F0F0F0');
                        doc.roundedRect(x + 2, y + 2, width, height, cornerRadius, cornerRadius, 'F');
                        
                        // Redraw the main table border on top
                        doc.setDrawColor(brandColor);
                        doc.setLineWidth(1.5);
                        doc.roundedRect(x, y, width, height, cornerRadius, cornerRadius, 'S');
                    }
                };
                const isClientPDF = (pdfType === 'client');

                if (flights.length > 0) {
                    addSectionHeader(t.flights); tableConfig.startY = yPos;
                    doc.autoTable({ ...tableConfig, head: isClientPDF ? [['Airline', 'Route', 'Date', 'Description']] : [['Airline', 'Route', 'Date', 'Description', 'Cost']], body: flights.map(f => { const row = [sanitizeText(f.airline), `${sanitizeText(f.departure)} to ${sanitizeText(f.arrival)}`, formatDateToDDMMYYYY(f.flightDate), sanitizeText(f.flightDescription)]; if (!isClientPDF) row.push(formatCurrencyForPDF(f.flightCost)); return row; }), columnStyles: { 0: { cellWidth: 100 }, 1: { cellWidth: 100 }, 2: { cellWidth: 70 }, 3: { overflow: 'linebreak' }, 4: !isClientPDF ? {halign: 'right'} : {} } }); yPos = doc.autoTable.previous.finalY;
                }
                 if (trains.length > 0) {
                    addSectionHeader(t.trains); tableConfig.startY = yPos;
                    doc.autoTable({ ...tableConfig, head: isClientPDF ? [['Operator', 'Date', 'Time', 'Description']] : [['Operator', 'Date', 'Time', 'Description', 'Cost']], body: trains.map(t => { const row = [sanitizeText(t.name), formatDateToDDMMYYYY(t.date), t.time || '', sanitizeText(t.description)]; if (!isClientPDF) row.push(formatCurrencyForPDF(t.trainCost)); return row; }), columnStyles: { 1: { cellWidth: 70 }, 3: { overflow: 'linebreak' }, 4: !isClientPDF ? { halign: 'right' } : {} } }); yPos = doc.autoTable.previous.finalY;
                }
                if (buses.length > 0) {
                    addSectionHeader(t.buses); tableConfig.startY = yPos;
                    doc.autoTable({ ...tableConfig, head: isClientPDF ? [['Operator', 'Date', 'Description']] : [['Operator', 'Date', 'Description', 'Cost']], body: buses.map(b => { const row = [sanitizeText(b.name), formatDateToDDMMYYYY(b.date), sanitizeText(b.description)]; if (!isClientPDF) row.push(formatCurrencyForPDF(b.busCost)); return row; }), columnStyles: { 1: { cellWidth: 70 }, 2: { overflow: 'linebreak' }, 3: !isClientPDF ? { halign: 'right' } : {} } }); yPos = doc.autoTable.previous.finalY;
                }
                if (transfers.length > 0) {
                    addSectionHeader(t.transfers); tableConfig.startY = yPos;
                    doc.autoTable({ ...tableConfig, head: isClientPDF ? [['Name', 'Type']] : [['Name', 'Type', 'Cost']], body: transfers.map(t => { const row = [sanitizeText(t.name), sanitizeText(t.type)]; if (!isClientPDF) row.push(formatCurrencyForPDF(t.cost)); return row; }), columnStyles: { 2: !isClientPDF ? { halign: 'right' } : {} } }); yPos = doc.autoTable.previous.finalY;
                }
                if (hotels.length > 0) {
                    addSectionHeader(t.hotels); tableConfig.startY = yPos;
                    const hotelColumnStyles = isClientPDF 
                        ? { 3: { cellWidth: 75 }, 4: { cellWidth: 75 }, 5: { cellWidth: 50, halign: 'center' } } 
                        : { 3: { cellWidth: 65 }, 4: { cellWidth: 65 }, 5: { cellWidth: 50, halign: 'center' }, 6: { halign: 'right' } };
                    
                    doc.autoTable({ ...tableConfig, head: isClientPDF ? [['Hotel', 'Location', 'Room Category', 'Check-in', 'Check-out', 'Nights']] : [['Hotel', 'Location', 'Room Category', 'Check-in', 'Check-out', 'Nights', 'Total Cost']], 
                    body: hotels.map(h => { const hotelNights = calculateNights(h.checkIn, h.checkOut); const row = [sanitizeText(h.hotelName), sanitizeText(h.hotelLocation), sanitizeText(h.roomCategory), formatDateToDDMMYYYY(h.checkIn), formatDateToDDMMYYYY(h.checkOut), hotelNights]; if (!isClientPDF) row.push(formatCurrencyForPDF(h.hotelCost)); return row; }), 
                    columnStyles: hotelColumnStyles
                    }); 
                    yPos = doc.autoTable.previous.finalY;
                }
                if (activities.length > 0) {
                    addSectionHeader(t.activities); tableConfig.startY = yPos;
                    doc.autoTable({ ...tableConfig, head: isClientPDF ? [['Activity', 'Location', 'Date', 'Description']] : [['Activity', 'Location', 'Date', 'Description', 'Cost']], body: activities.map(a => { const row = [sanitizeText(a.activityName), sanitizeText(a.activityLocation), formatDateToDDMMYYYY(a.activityDate), sanitizeText(a.activityDescription) || '']; if (!isClientPDF) row.push(formatCurrencyForPDF(a.activityCost)); return row; }), 
                    columnStyles: { 
                        0: { cellWidth: 200, overflow: 'linebreak' }, 
                        1: { cellWidth: 80 }, 
                        2: { cellWidth: 70 }, 
                        3: { overflow: 'linebreak' }, 
                        4: !isClientPDF ? { halign: 'right' } : {} 
                    } 
                }); yPos = doc.autoTable.previous.finalY;
                }
                
                const dayWiseData = [];
                if (nights >= 0 && startDate) { 
                    const start = new Date(startDate);
                    for (let i = 0; i <= nights; i++) {
                        const d = new Date(start); d.setUTCDate(d.getUTCDate() + i); const dateStr = d.toISOString().split('T')[0];
                        let events = [];
                        hotels.filter(h => h.checkOut === dateStr).forEach(h => events.push(`Check-out: ${sanitizeText(h.hotelName)}, ${sanitizeText(h.hotelLocation)}`));
                        flights.filter(f => f.flightDate === dateStr).forEach(f => events.push(`Flight: ${sanitizeText(f.airline)} (${sanitizeText(f.departure)} to ${sanitizeText(f.arrival)})`));
                        trains.filter(t => t.date === dateStr).forEach(t => events.push(`Train: ${sanitizeText(t.name)} - ${sanitizeText(t.description)}`));
                        buses.filter(b => b.date === dateStr).forEach(b => events.push(`Bus: ${sanitizeText(b.name)} - ${sanitizeText(b.description)}`));
                        hotels.filter(h => h.checkIn === dateStr).forEach(h => events.push(`Check-in: ${sanitizeText(h.hotelName)}, ${sanitizeText(h.hotelLocation)}`));
                        activities.filter(a => a.activityDate === dateStr).forEach(a => events.push(`Activity: ${sanitizeText(a.activityName)} (${sanitizeText(a.activityLocation)})`));
                        
                        if (events.length > 0) {
                            dayWiseData.push({
                                day: i + 1,
                                date: d.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' }),
                                events: events
                            });
                        }
                    }
                }
                
                if (dayWiseData.length > 0) {
                    addSectionHeader(t.daywiseItinerary);
                    yPos += 15;

                    const timelineX = margin + 10;
                    const contentX = timelineX + 25;
                    const contentWidth = usableWidth - (contentX - margin);
                    
                    const dayElementPositions = [];

                    dayWiseData.forEach(dayData => {
                        let requiredHeight = 0;
                        const headerHeight = 25;
                        let eventsHeight = 0;
                        dayData.events.forEach(event => {
                            const lines = doc.splitTextToSize(`• ${event}`, contentWidth - 5);
                            eventsHeight += (lines.length * 10) + 8;
                        });
                        requiredHeight = headerHeight + eventsHeight + 20;

                        checkPageBreak(requiredHeight);
                        dayElementPositions.push({ y: yPos, page: doc.internal.getCurrentPageInfo().pageNumber, data: dayData });
                        
                        let currentContentY = yPos;
                        doc.setFontSize(11).setFont('Helvetica', 'bold').setTextColor(textColor).text(`Day ${dayData.day}: ${dayData.date}`, contentX, currentContentY);
                        currentContentY += 20;

                        doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(lightTextColor);
                        dayData.events.forEach(event => {
                            const eventLines = doc.splitTextToSize(`• ${event}`, contentWidth - 5);
                            doc.text(eventLines, contentX, currentContentY);
                            currentContentY += (eventLines.length * 10) + 8;
                        });
                        yPos = currentContentY + 15;
                    });
                    
                    const totalPages = doc.internal.getNumberOfPages();
                    for(let page = 1; page <= totalPages; page++) {
                        doc.setPage(page);
                        const elementsOnPage = dayElementPositions.filter(p => p.page === page);
                        if(elementsOnPage.length > 0) {
                            const firstElementY = elementsOnPage[0].y;
                            const lastElementY = elementsOnPage[elementsOnPage.length - 1].y;
                            doc.setDrawColor(borderColor).setLineWidth(1.5).line(timelineX, firstElementY, timelineX, lastElementY);

                            elementsOnPage.forEach(pos => {
                                doc.setFillColor('#FFFFFF').circle(timelineX, pos.y, 11, 'F');
                                doc.setFillColor(brandColor).circle(timelineX, pos.y, 10, 'F');
                                doc.setFontSize(9).setFont('Helvetica', 'bold').setTextColor('#FFFFFF').text(String(pos.data.day), timelineX, pos.y + 3, { align: 'center' });
                            });
                        }
                    }
                    doc.setPage(totalPages);
                }
                
                const addIncExcList = (title, items) => { const checkedItems = items.filter(item => item.checked).map(item => sanitizeText(item.text)); if (checkedItems.length === 0) return; addSectionHeader(title); addBulletedList(checkedItems); };
                addIncExcList(t.inclusions, inclusions); addIncExcList(t.exclusions, exclusions);
                
                const totalFlightCost = flights.reduce((s, f) => s + (f.flightCost || 0), 0);
                const totalTrainCost = trains.reduce((s, t) => s + (t.trainCost || 0), 0);
                const totalBusCost = buses.reduce((s, b) => s + (b.busCost || 0), 0);
                const totalTransferCost = transfers.reduce((s, t) => s + (t.cost || 0), 0);
                const totalHotelCost = hotels.reduce((s, h) => s + (h.hotelCost || 0), 0);
                const totalActivityCost = activities.reduce((s, a) => s + (a.activityCost || 0), 0);
                const marginCost = parseFloat(document.getElementById("marginCost").value) || 0;
                const totalCost = totalFlightCost + totalTrainCost + totalBusCost + totalTransferCost + totalHotelCost + totalActivityCost + marginCost;

                checkPageBreak(isClientPDF ? 80 : 120);
                yPos += 30; doc.setDrawColor(borderColor).line(margin, yPos, pageWidth - margin, yPos); yPos += 10;
                
                if (!isClientPDF) {
                    const subtotal = totalCost - marginCost;
                    doc.setFontSize(12).setFont('Helvetica', 'normal').setTextColor(lightTextColor);
                    doc.text('Subtotal', margin, yPos + 15);
                    doc.text(formatCurrencyForPDF(subtotal), pageWidth - margin, yPos + 15, { align: 'right' });
                    yPos += 20;

                    doc.text('Margin', margin, yPos + 15);
                    doc.text(formatCurrencyForPDF(marginCost), pageWidth - margin, yPos + 15, { align: 'right' });
                    yPos += 20;
                }

                doc.setFontSize(16).setFont('Helvetica', 'bold').setTextColor(textColor);
                doc.text(t.totalCost, margin, yPos + 15);
                doc.text(formatCurrencyForPDF(totalCost), pageWidth - margin, yPos + 15, { align: 'right' });
                yPos += 25; doc.line(margin, yPos, pageWidth - margin, yPos); yPos += 10;

                const aboutText = "At Travelverse, we believe travel should be extraordinary. Born from a passion for exploring, we specialize in crafting unique, tailor-made journeys that match your personal style. We handle all the details, from handpicking the best local partners to providing seamless support, so you can focus on creating unforgettable memories. With Travelverse, you get more than a trip; you get a perfectly organized, stress-free adventure designed just for you.";
                addSectionHeader(t.about);
                const aboutLines = doc.splitTextToSize(aboutText, usableWidth);
                checkPageBreak(aboutLines.length * 12);
                doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(lightTextColor);
                doc.text(aboutText, margin, yPos, { maxWidth: usableWidth, align: 'justify' });
                yPos += (aboutLines.length * 11) + 10;

                addSectionHeader(t.terms);
                const terms = [
                    "This document is a quotation; no bookings have been made. All services are subject to availability at the time of booking.",
                    "To confirm the booking, a deposit of 50% of the total tour price is required.",
                    "All prices are quoted in INR and are subject to change without notice due to currency fluctuations, new government taxes, or other factors beyond our control.",
                    "We act as agents for hotels, airlines, and transport operators, and are not liable for any loss, injury, or damage sustained by the traveler directly or indirectly.",
                    "Please ensure you possess a valid passport and any required visas for the duration of your trip. Visa assistance is an optional service."
                ];
                addBulletedList(terms);
                
                addSectionHeader(t.downloadApp);
                const appText = "For live updates, offline access to your documents, and direct communication with our team during your trip, download our dedicated mobile app.";
                const appTextLines = doc.splitTextToSize(appText, usableWidth);
                checkPageBreak((appTextLines.length * 12) + 80);
                doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(lightTextColor);
                doc.text(appText, margin, yPos, { maxWidth: usableWidth, align: 'justify' });
                yPos += (appTextLines.length * 11) + 25;

                const appStoreLink = "https://apps.apple.com/cn/app/travelverse-in/id6739727152";
                const playStoreLink = "https://play.google.com/store/apps/details?id=com.travelverse.travelverse_mobile_app&hl=en_IN";
                
                const buttonWidth = (usableWidth / 2) - 10;
                const buttonHeight = 50;
                const buttonRadius = 12;
                const buttonY = yPos;

                // App Store Button (Transparent)
                const appleButtonX = margin;
                doc.setDrawColor(borderColor);
                doc.setFillColor('#f0f0f2');
                doc.roundedRect(appleButtonX, buttonY, buttonWidth, buttonHeight, buttonRadius, buttonRadius, 'FD');
                doc.link(appleButtonX, buttonY, buttonWidth, buttonHeight, { url: appStoreLink });
                
                // App Store text
                const appleTextX = appleButtonX + 25;
                doc.setFont('Helvetica', 'normal');
                doc.setFontSize(8).setTextColor(lightTextColor).text('DOWNLOAD ON THE', appleTextX, buttonY + 18);
                doc.setFont('Helvetica', 'bold');
                doc.setFontSize(13).setTextColor(textColor).text('App Store', appleTextX, buttonY + 32);
                
                // Google Play Store Button (Transparent)
                const googleButtonX = margin + buttonWidth + 20;
                doc.setDrawColor(borderColor);
                doc.setFillColor('#f0f0f2');
                doc.roundedRect(googleButtonX, buttonY, buttonWidth, buttonHeight, buttonRadius, buttonRadius, 'FD');
                doc.link(googleButtonX, buttonY, buttonWidth, buttonHeight, { url: playStoreLink });
                
                // Google Play text
                const googleTextX = googleButtonX + 25;
                doc.setFont('Helvetica', 'normal');
                doc.setFontSize(8).setTextColor(lightTextColor).text('GET IT ON', googleTextX, buttonY + 18);
                doc.setFont('Helvetica', 'bold');
                doc.setFontSize(13).setTextColor(textColor).text('Google Play', googleTextX, buttonY + 32);
                
                yPos = buttonY + buttonHeight + 10;
                
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8).setFont('Helvetica', 'normal').setTextColor(lightTextColor);
                    doc.text(`${t.page} ${i} ${t.of} ${pageCount}`, pageWidth - margin, pageHeight - 20, { align: 'right' });
                }

                doc.setPage(pageCount);
                const footerHeight = 60;
                if (pageHeight - yPos < footerHeight + margin) {
                   doc.addPage();
                   const newPageCount = doc.internal.getNumberOfPages();
                   for (let i = 1; i <= newPageCount; i++) { doc.setPage(i); doc.text(`Page ${i} of ${newPageCount}`, pageWidth - margin, pageHeight - 20, { align: 'right' });}
                   doc.setPage(newPageCount);
                }
                
                doc.setFillColor(brandColor);
                doc.rect(0, pageHeight - footerHeight, pageWidth, footerHeight, 'F');
                doc.setFontSize(10).setFont('Helvetica', 'bold').setTextColor('#FFFFFF');
                doc.text(t.craftedBy + ' ' + clientName + '.', pageWidth / 2, pageHeight - footerHeight + 28, { align: 'center' });
                doc.setFontSize(9).setFont('Helvetica', 'normal');
                doc.text(t.whereEveryJourney, pageWidth / 2, pageHeight - footerHeight + 45, { align: 'center' });
                
                let fileName;
                if (pdfType === 'premium') {
                    fileName = `Premium_Itinerary_${clientName.replace(/\s/g, '_')}_${formatDateToDDMMYYYY(startDate)}.pdf`;
                } else {
                    fileName = `Itinerary_${isClientPDF ? 'Client' : 'Business'}_${clientName.replace(/\s/g, '_')}_${formatDateToDDMMYYYY(startDate)}.pdf`;
                }
                doc.save(fileName);

            } catch (error) {
                console.error("An unexpected error occurred during PDF generation:", error);
                alert("An unexpected error occurred while creating the PDF. Check the console for details.");
            }
        }
        
        // Premium PDF Enhancement
        function addPremiumFeatures(doc, themeColors, margin, pageWidth) {
            // Add premium watermark
            doc.setTextColor(themeColors.primaryColor);
            doc.setFontSize(60);
            doc.setFont('Helvetica', 'bold');
            doc.text('PREMIUM', pageWidth / 2, 200, { align: 'center', angle: 45, opacity: 0.1 });
            
            // Add premium border
            doc.setDrawColor(themeColors.primaryColor);
            doc.setLineWidth(3);
            doc.rect(margin - 10, margin - 10, pageWidth - (margin * 2) + 20, doc.internal.pageSize.height - (margin * 2) + 20);
            
            // Add premium footer
            const footerY = doc.internal.pageSize.height - 40;
            doc.setFillColor(themeColors.primaryColor);
            doc.rect(0, footerY, pageWidth, 40, 'F');
            doc.setTextColor('#FFFFFF');
            doc.setFontSize(10);
            doc.text('Premium Itinerary - Enhanced with AI-Powered Recommendations', pageWidth / 2, footerY + 25, { align: 'center' });
        }

        window.onload = function() {
            initializeCollapsibleSections();
            initializeTheme();
            initializeAuth();
            loadData();
            setupAutoSave();
        };
        
        function setupAutoSave() {
            // Add event listeners to all form inputs for auto-save
            const formInputs = document.querySelectorAll('input, select, textarea');
            formInputs.forEach(input => {
                input.addEventListener('input', debouncedSave);
                input.addEventListener('change', debouncedSave);
            });
            
            // Also save when window loses focus
            window.addEventListener('beforeunload', () => {
                if (saveTimeout) {
                    clearTimeout(saveTimeout);
                    saveData();
                }
            });
        // Enhanced Collapsible Sections Functionality
        function initializeCollapsibleSections() {
            const cards = document.querySelectorAll(".card:not(.collapsible)");
            cards.forEach((card, index) => {
                if (!card.id) {
                    card.id = `section_${index}`;
                }
                
                const h2 = card.querySelector("h2");
                if (h2 && !card.querySelector(".card-header")) {
                    const title = h2.textContent;
                    const content = card.innerHTML;
                    
                    card.classList.add("collapsible");
                    card.innerHTML = `
                        <div class="card-header" onclick="toggleSection("${card.id}")">
                            <h2>${title}</h2>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="card-content">
                            ${content.replace(`<h2>${title}</h2>`, "")}
                        </div>
                    `;
                }
            });
        }

        // Enhanced toggle function with smooth animations
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                const isCollapsed = section.classList.contains("collapsed");
                const content = section.querySelector(".card-content");
                const icon = section.querySelector(".toggle-icon");
                
                if (isCollapsed) {
                    // Expand
                    section.classList.remove("collapsed");
                    content.style.display = "block";
                    content.style.maxHeight = content.scrollHeight + "px";
                    if (icon) icon.textContent = "▼";
                } else {
        // Save section states to localStorage
        function saveSectionStates() {
            const sections = document.querySelectorAll(".collapsible");
            const states = {};
            sections.forEach(section => {
                states[section.id] = section.classList.contains("collapsed");
            });
            localStorage.setItem("sectionStates", JSON.stringify(states));
        }

        // Load section states from localStorage
        function loadSectionStates() {
            const states = JSON.parse(localStorage.getItem("sectionStates") || "{}");
            Object.keys(states).forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section && states[sectionId]) {
                    section.classList.add("collapsed");
                    const content = section.querySelector(".card-content");
                    const icon = section.querySelector(".toggle-icon");
                    if (content) content.style.display = "none";
                    if (icon) icon.textContent = "▶";
                }
            });
        }
                    // Collapse
                    section.classList.add("collapsed");
                    content.style.maxHeight = "0";
                    setTimeout(() => {
                        content.style.display = "none";
                    }, 300);
                    if (icon) icon.textContent = "▶";
                }
            }
        }

        // Add collapse all / expand all functionality
        function toggleAllSections(expand = true) {
            const sections = document.querySelectorAll(".collapsible");
            sections.forEach(section => {
                const content = section.querySelector(".card-content");
                const icon = section.querySelector(".toggle-icon");
                
                if (expand) {
                    section.classList.remove("collapsed");
                    content.style.display = "block";
                    content.style.maxHeight = content.scrollHeight + "px";
                    if (icon) icon.textContent = "▼";
                } else {
                    section.classList.add("collapsed");
                    content.style.maxHeight = "0";
                    setTimeout(() => {
                        content.style.display = "none";
                    }, 300);
                    if (icon) icon.textContent = "▶";
                }
            });
        }
        }
    </script>
</body>
</html>
